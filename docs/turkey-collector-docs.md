# Документация и инструкция по использованию `turkey_collector.py` и `turkey_processor.py`

## 1. Назначение скриптов

### `turkey_collector.py`
Скрипт предназначен для автоматического сбора **сырых данных** по внешней торговле между Росией и Турцией с сайта института статистики Турции ([biruni.tuik.gov.tr](https://biruni.tuik.gov.tr/disticaretapp/disticaret_ing.zul?param1=4&param2=24&sitcrev=0&isicrev=0&sayac=5902")) . 
Скрипт открывает страницу с формой для запроса данных, заполняет неоходимые поля, отправляет запрос и собирает следующее:

- список и описание кодов ТНВЭД, сохраняет их в json-файл
- html страницы с данными по кодам ТНВЭД

### `turkey_processor.py`
Скрипт предназначен для **обработки, проверки качества и объединения** всех сырых файлов, собранных `turkey_collector.py`. Он сканирует директорию с с данными в виде html страниц, консолидирует их результирующую таблицу и приводит ее к гармонизированному виду на основании [модели данных](https://github.com/quantviews/mgimo-foreign-trade/blob/main/docs/data_model.md) и сохраняет результат в виде parquet файла.

## 2. Использование

[Схема процесса сбора и обработки данных](https://github.com/quantviews/mgimo-foreign-trade/blob/main/fig/turkey-data-collection.png)

### Шаг 1: Сбор сырых данных с `turkey_collector.py`

**Важно:** Запускайте скрипт из корневой директории проекта:
```bash
cd F:\YandexDisk\HSE\mgimo-foreign_trade
```

1.  **Загрузка кодов и сырых данных** (автоматически использует существующие коды, если файл уже есть):
    ```bash
    python src/collectors/turkey_collector.py 2025 
    ```
    Скрипт проверяет наличие файла `hs_codes_json/turkey_codes2025.json`. Если файл существует, использует его. Если нет - загружает коды, затем собирает данные.

2.  **Загрузка только кодов** (без сбора данных):
    ```bash
    python src/collectors/turkey_collector.py 2025 --codes
    ```
    или короткая форма:
    ```bash
    python src/collectors/turkey_collector.py 2025 -c
    ```

3.  **Сбор данных без проверки/загрузки кодов** (использует только существующий файл с кодами):
    ```bash
    python src/collectors/turkey_collector.py 2025 --skip-codes
    ```
    ⚠️ **Внимание:** Файл `hs_codes_json/turkey_codes2025.json` должен уже существовать. Если файла нет, скрипт выдаст ошибку.
    
    Этот режим полезен для повторных запусков, когда коды уже загружены и нужно только собрать данные.

**Параметры:**
- `year` (обязательный): Год данных (2005-текущий год)
- `-c, --codes`: Загрузить только коды, без сбора данных
- `--skip-codes`: Пропустить проверку/загрузку кодов, использовать только существующий файл

### Шаг 2: Обработка данных с `turkey_processor.py`

1.  **Обработка данных за определенный год** Пользователь запускает скрипт указывая необходимый год.
    ```bash
    % python turkey_processor.py 2025
    ```
2.  **Обработка всех доступных данных** Пользователь запускает скрипт с ключом -a
    ```bash
    % python turkey_processor.py -a
    ```

## 3. Требования

**Cторонние Python библиотеки:**
- `playwright` - для автоматизации браузера
- `pandas` - для работы с данными
- `numpy` - для численных операций
- `bs4` (BeautifulSoup) - для парсинга HTML

**Установка зависимостей:**
```bash
pip install playwright pandas numpy beautifulsoup4
playwright install chromium
```

## 4. Особенности работы

### Обработка таймаутов
Скрипт автоматически обрабатывает таймауты при загрузке страниц:
- Основной таймаут увеличен до 60 секунд (вместо 30)
- При таймауте `networkidle` используется альтернативный подход с ожиданием `domcontentloaded` + задержка
- Скрипт продолжает работу даже при временных проблемах с загрузкой

### Повторные запуски
- Если файл с кодами уже существует, он не будет перезагружаться (кроме случая повреждения файла)
- Уже загруженные HTML файлы не перезаписываются автоматически
- Для полной перезагрузки удалите соответствующие файлы вручную

## 5. Связанные файлы и директории

**Скрипты:**
-   **`src/collectors/turkey_collector.py`**: Скрипт для выгрузки кодов и сырых данных.
-   **`src/collectors/turkey_processor.py`**: Скрипт для обработки и объединения сырых данных.

**Директории с данными:**
-   **`data_raw/turkey/raw_html_tables/YYYY/`**: Директория для хранения сырых данных (HTML страниц) за год YYYY
    - Формат файлов: `XXXXXX-YYYYYY-YYYY.html` (диапазон кодов-год)
-   **`data_raw/turkey/hs_codes_json/`**: Директория для JSON-файлов с HS8 кодами
    - Формат файлов: `turkey_codesYYYY.json`
-   **`data_processed/turkey/`**: Директория для обработанных данных
    - **`tr_full.parquet`**: Финальный, обработанный файл с данными

## 6. Примеры использования

### Пример 1: Первый запуск для нового года
```bash
# Загрузить коды и данные за 2025 год
python src/collectors/turkey_collector.py 2025
```

### Пример 2: Только загрузка кодов
```bash
# Загрузить только коды без сбора данных
python src/collectors/turkey_collector.py 2025 -c
```

### Пример 3: Повторный запуск после сбоя
```bash
# Если сбор данных прервался, можно продолжить без перезагрузки кодов
python src/collectors/turkey_collector.py 2025 --skip-codes
```

### Пример 4: Обработка данных
```bash
# Обработать данные за 2025 год
python src/collectors/turkey_processor.py 2025

# Обработать все доступные данные
python src/collectors/turkey_processor.py -a
```

## 7. Устранение проблем

### Проблема: Таймаут при загрузке страницы
**Решение:** Скрипт автоматически обрабатывает таймауты. Если проблема повторяется:
- Проверьте интернет-соединение
- Убедитесь, что сайт доступен
- Попробуйте запустить снова - скрипт продолжит с того места, где остановился

### Проблема: Ошибка "Codes file not found" при использовании --skip-codes
**Решение:** Сначала загрузите коды:
```bash
python src/collectors/turkey_collector.py 2025 -c
```

### Проблема: Поврежденный файл с кодами
**Решение:** Скрипт автоматически обнаружит проблему и перезагрузит коды. Или удалите файл вручную и запустите снова.

