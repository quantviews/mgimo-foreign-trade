# Документация по процессору данных Китая

## Обзор

Файл `china_processor.py` предназначен для обработки сырых данных внешней торговли Китая и преобразования их в унифицированный формат согласно модели данных проекта. Скрипт автоматически находит CSV файлы из папки `data_raw/china/`, обрабатывает их и создает результирующий файл `ch_full.parquet`.

## Основные функции

### 1. Загрузка маппинга кодов Китая

**Функция:** `load_china_codes_mapping(codes_dir: Path) -> dict`

**Назначение:** Загружает информацию о единицах измерения из CSV файлов china-codes для создания маппинга между кодами TNVED и единицами измерения.

**Процесс выполнения:**
- Ищет все файлы `*-china.csv` в директории `metadata/china-codes/` (сами коды взяты отсюда - http://stats.customs.gov.cn/indexEn - Codes - Commodity)
- Создает маппинг английских названий единиц измерения к ISO кодам
- Предоставляет подробную отчетность о покрытии маппинга

**Пример маппинга:**
```python
english_to_iso_mapping = {
    "Number of item": "796",      # ШТУКА
    "Piece": "796",               # ШТУКА  
    "Pair": "715",                # ПАРА
    "Square Metre": "055",        # КВАДРАТНЫЙ МЕТР
    "Kilogram": "166",            # КИЛОГРАММ
    "Litre": "112",               # ЛИТР
    "Cubic Metre": "113",         # КУБИЧЕСКИЙ МЕТР
}
```

### 2. Основная обработка данных

**Функция:** `process_and_merge_china_data(raw_data_dir: Path, output_file: Path, codes_dir: Path = None)`

**Алгоритм обработки:**

#### Шаг 1: Поиск файлов данных
- Сканирует директории `IMPORT/` и `EXPORT/` в `data_raw/china/`
- Ищет файлы с паттерном `data*.csv`

#### Шаг 2: Трансформация данных
Для каждого найденного файла выполняется:

1. **Обработка периода:**
   ```python
   df['PERIOD'] = df['PERIOD'] + '-01'  # 202301 → 2023-01-01
   ```

2. **Установка страны:**
   ```python
   df['STRANA'] = 'CN'  # Все записи относятся к Китаю
   ```

3. **Переименование колонок:**
   ```python
   df = df.rename(columns={
       'Supplementary Quantity': 'KOL',
       'Supplementary Unit': 'EDIZM'
   })
   ```

4. **Нормализация TNVED кодов:**
   ```python
   tnved_cols = {'TNVED': 8, 'TNVED2': 2, 'TNVED4': 4, 'TNVED6': 6}
   for col, length in tnved_cols.items():
       df[col] = df[col].astype(str).str.zfill(length)
   ```

#### Шаг 3: Маппинг единиц измерения
```python
# Всегда инициализируется колонка EDIZM_ISO
df['EDIZM_ISO'] = '?'

# Если доступен маппинг кодов Китая, применяется:
if codes_mapping and 'TNVED' in df.columns:
    df['EDIZM_ISO'] = df['TNVED'].map(lambda x: codes_mapping.get(str(x).zfill(8), {}).get('EDIZM_ISO', '?'))
```

#### Шаг 4: Упорядочивание колонок
```python
standard_columns = [
    'NAL', 'PERIOD', 'STRANA', 'TNVED', 'EDIZM', 'EDIZM_ISO', 'STOIM', 
    'NETTO', 'KOL', 'TNVED4', 'TNVED6', 'TNVED2'
]
```

### 3. Обработка ошибок кодировки

**Проблема:** CSV файлы china-codes могут иметь проблемы с кодировкой (не UTF-8).

**Решение:** Попытка загрузки с различными кодировками через цикл `for encoding in encodings_to_try`.

**Поддерживаемые кодировки:**
- UTF-8
- UTF-8-sig  
- CP1252 (Windows)
- CP1251 (Russian)
- Latin1
- ISO-8859-1

### 4. Финализация данных

#### Очистка нечисленных символов
```python
# NETTO колонка может содержать табы и другие символы
final_df['NETTO'] = pd.to_numeric(
    final_df['NETTO'].astype(str).str.strip(), 
    errors='coerce'
)

# То же для KOL
final_df['KOL'] = pd.to_numeric(
    final_df['KOL'].astype(str).str.strip(),
    errors='coerce'
)
```

#### Проверка временных рядов
- Определяет минимальную и максимальную даты
- Вычисляет ожидаемые месяцы в диапазоне
- Проверяет наличие пропусков в данных
- Выводит предупреждения о недостающих месяцах

### 5. Логирование и отчетность

**Уровни логирования:**
- `INFO`: Основной прогресс обработки
- `WARNING`: Пропущенные месяцы, ненайденные единицы измерения
- `ERROR`: Критические ошибки обработки
- `DEBUG`: Детальная информация об успешном декодировании

**Статистические отчеты:**
```
=== MERGE SUMMARY ===
Total sources: 1
Total rows: 525,499
Unique countries: 1
Date range: 2017-01-01 to 2025-07-01
Unique TNVED codes: 8,547
EDIZM_ISO mapping: 0/525,499 rows (0.0%) successfully mapped
EDIZM_ISO filled: 525,499/525,499 rows (100.0%) have values
```

## Структура входных данных

### Директория: `data_raw/china/`
```
IMPORT/
├── data201701.csv
├── data201702.csv
├── ...
├── data202507.csv
EXPORT/  
├── data201701.csv
├── data201702.csv
├── ...
└── data202507.csv
```

### Формат столбцов исходных данных:
- `NAL`: Направление торговли (И/Э)  
- `PERIOD`: Месяц в формате YYYYMM (202301)
- `STRANA`: Код страны партнера
- `TNVED`: Код товара по ТН ВЭД
- `Supplementary Unit`: Дополнительная единица измерения
- `Supplementary Quantity`: Количество в дополнительной единице
- `STOIM`: Стоимость в **тысячах USD**
- `NETTO`: Вес нетто в килограммах

## Структура выходных данных

### Файл: `data_processed/ch_full.parquet`

| Колонка | Тип | Описание | Значения |
|---------|-----|----------|----------|
| `NAL` | VARCHAR | Направление торговли | ИМ/ЭК |
| `PERIOD` | Datetime | Период данных | 2023-01-01 |
| `STRANA` | VARCHAR | Страна партнер | CN |
| `TNVED` | VARCHAR | Код товара | 0101210000 |
| `EDIZM` | VARCHAR | Единица измерения | Number of item |
| `EDIZM_ISO` | VARCHAR | ISO код единицы | 796 |
| `STOIM` | DECIMAL | Стоимость в USD | 12500.50 |
| `NETTO` | DECIMAL | Вес в кг | 450.0 |
| `KOL` | DECIMAL | Количество | 150 |
| `TNVED2` | VARCHAR | 2-значный код | 01 |
| `TNVED4` | VARCHAR | 4-значный код | 0101 |
| `TNVED6` | VARCHAR | 6-значный код | 010121 |

## Особенности реализации

### 1. Надежность обработки кодировки
Автоматическое определение кодировки с детальным логированием неудач и успехов.

### 2. Нормализация данных  
Полная нормализация кодов товаров и дат согласно стандартизированной модели данных.

### 3. Обработка ошибок графизмов
Умная очистка неструктурированных данных в числовых полях.

### 4. Полная трассировка процессов
Подробное логирование всех этапов обработки для отладки и мониторинга.

## Использование

```bash
cd src/collectors
python china_processor.py
```

**Предварительные требования:**
- `pandas`
- `pyarrow` (для сохранения parquet)
- Доступ к папкам `data_raw/china/` и `metadata/china-codes/`

## Расширение функциональности

### Добавление новых единиц измерения
Обновить словарь `english_to_iso_mapping` в функции `load_china_codes_mapping()`:
```python
english_to_iso_mapping = {
    "New Unit": "XXX",  # Добавить новый маппинг
}
```

### Валидация данных
Добавить дополнительные проверки в секцию финализации для обеспечения качества данных.
