# Документация для `extract_country_tnved2_slice.py`

Этот документ описывает работу скрипта `extract_country_tnved2_slice.py`, который предназначен для извлечения срезов данных из итоговой базы данных по стране и двухзначному коду TNVED.

## Описание

Скрипт `extract_country_tnved2_slice.py` позволяет извлекать данные из базы данных `unified_trade_data.duckdb` с фильтрацией по стране (ISO2 код) и двухзначному коду TNVED (`TNVED2`). Извлеченные данные сохраняются в формате CSV в папку `data_interim_csv/`.

Скрипт использует представление **`unified_trade_data_enriched`**, которое включает названия стран и кодов TNVED, что делает извлеченные данные более информативными и удобными для анализа. Для обработки данных используется библиотека **polars**, что обеспечивает высокую производительность.

Скрипт поддерживает различные режимы работы: извлечение конкретного среза, всех кодов для страны, всех стран для кода, или всех возможных комбинаций.

## Логика работы скрипта

Скрипт выполняет следующие шаги:

1. **Подключение к базе данных**: Скрипт подключается к базе данных `db/unified_trade_data.duckdb` в режиме только чтения (`read_only=True`).

2. **Построение SQL-запроса**: 
   - Базовый запрос выбирает все данные из представления `unified_trade_data_enriched`, которое включает:
     - Все колонки из основной таблицы `unified_trade_data`
     - Названия стран (`COUNTRY_NAME`)
     - Названия кодов TNVED разных уровней (`TNVED2_NAME`, `TNVED4_NAME`, `TNVED6_NAME`, `TNVED8_NAME`, `TNVED_NAME`)
     - Ранжирование по периодам (`period_rank`)
   - В зависимости от переданных аргументов добавляются условия фильтрации:
     - Если указан `--country`, добавляется условие `STRANA = ?` (значение приводится к верхнему регистру)
     - Если указан `--tnved2`, добавляется условие `TNVED2 = ?` (код дополняется ведущими нулями до 2 знаков)

3. **Выполнение запроса и преобразование данных**:
   - Запрос выполняется через DuckDB connection
   - Результат преобразуется в pandas DataFrame, затем в polars DataFrame для эффективной обработки

4. **Сохранение результатов**:
   - В зависимости от режима работы создаются один или несколько CSV файлов:
     - **Режим 1**: Указаны и страна, и код → создается один файл `{COUNTRY}_TNVED2_{CODE}.csv`
     - **Режим 2**: Указана только страна → создается отдельный файл для каждого `TNVED2` кода: `{COUNTRY}_TNVED2_{CODE}.csv`
     - **Режим 3**: Указан только код → создается отдельный файл для каждой страны: `{COUNTRY}_TNVED2_{CODE}.csv`
     - **Режим 4**: Не указаны ни страна, ни код → создается отдельный файл для каждой комбинации страна-код: `{COUNTRY}_TNVED2_{CODE}.csv`
   - Все файлы сохраняются в папку `data_interim_csv/` (создается автоматически, если не существует)
   - Имена файлов формируются в формате: `{COUNTRY}_TNVED2_{CODE}.csv`, где:
     - `{COUNTRY}` — ISO2 код страны в верхнем регистре (например, `CN`, `IN`, `TR`)
     - `{CODE}` — двухзначный код TNVED с ведущими нулями (например, `01`, `27`, `87`)

5. **Логирование**: В процессе работы скрипт выводит подробную информацию о:
   - Пути к базе данных и выходной директории
   - Применяемых фильтрах
   - Количестве извлеченных строк
   - Путях к созданным файлам

## Как запустить скрипт

Скрипт запускается из командной строки и поддерживает несколько аргументов для управления процессом извлечения.

### Аргументы командной строки

*   `--country <ISO-код>` (опциональный): Двухбуквенный ISO-код страны для фильтрации (например, `CN`, `IN`, `TR`). Если не указан, извлекаются данные для всех стран.
*   `--tnved2 <код>` (опциональный): Двухзначный код TNVED для фильтрации (например, `01`, `27`, `87`). Если не указан, извлекаются данные для всех кодов.
*   `--db-path <путь>` (опциональный): Путь к базе данных `unified_trade_data.duckdb`. По умолчанию: `db/unified_trade_data.duckdb` относительно корня проекта.
*   `--output-dir <путь>` (опциональный): Директория для сохранения CSV файлов. По умолчанию: `data_interim_csv` относительно корня проекта.

### Примеры использования

**1. Извлечь конкретный срез (страна + код):**
```bash
python src/extract_country_tnved2_slice.py --country CN --tnved2 27
```
Создаст файл `CN_TNVED2_27.csv` с данными по Китаю для кода TNVED 27 (топливо, минеральные масла и продукты их перегонки).

**2. Извлечь все коды для конкретной страны:**
```bash
python src/extract_country_tnved2_slice.py --country CN
```
Создаст отдельные CSV файлы для каждого двухзначного кода TNVED, присутствующего в данных по Китаю: `CN_TNVED2_01.csv`, `CN_TNVED2_02.csv`, и т.д.

**3. Извлечь все страны для конкретного кода:**
```bash
python src/extract_country_tnved2_slice.py --tnved2 27
```
Создаст отдельные CSV файлы для каждой страны, имеющей данные по коду 27: `CN_TNVED2_27.csv`, `IN_TNVED2_27.csv`, и т.д.

**4. Извлечь все комбинации (создаст отдельные CSV для каждой пары страна-код):**
```bash
python src/extract_country_tnved2_slice.py
```
Создаст CSV файлы для всех возможных комбинаций страна-код, присутствующих в базе данных.

**5. Использование с указанием путей:**
```bash
python src/extract_country_tnved2_slice.py --country TR --tnved2 87 --db-path /path/to/db.duckdb --output-dir /path/to/output
```

## Технические детали

### Использование polars

Скрипт использует библиотеку **polars** для обработки данных, что обеспечивает:
*   Высокую производительность при работе с большими объемами данных
*   Эффективную фильтрацию и группировку данных
*   Оптимизированную запись в CSV формат

### Нормализация кодов

*   **Коды стран**: Все коды стран приводятся к верхнему регистру (`CN`, `IN`, `TR`).
*   **Коды TNVED2**: Коды дополняются ведущими нулями до 2 знаков (`1` → `01`, `27` → `27`).

### Обработка пустых результатов

Если запрос не вернул данных (например, указанная комбинация страна-код отсутствует в базе), скрипт выводит предупреждение и завершает работу без создания файла.

### Структура выходных файлов

CSV файлы содержат все колонки из представления `unified_trade_data_enriched`, включая:

**Основные колонки данных:**
*   `NAPR` — направление торговли (ИМ/ЭК)
*   `PERIOD` — отчетный период (дата)
*   `STRANA` — страна-отчет (ISO код)
*   `TNVED` — код ТН ВЭД (10 знаков)
*   `TNVED2`, `TNVED4`, `TNVED6`, `TNVED8` — производные коды разных уровней
*   `EDIZM` — единица измерения
*   `EDIZM_ISO` — ISO код единицы измерения
*   `STOIM` — стоимость в тысячах USD
*   `NETTO` — вес нетто в кг
*   `KOL` — количество в дополнительной единице

**Дополнительные колонки из enriched view:**
*   `COUNTRY_NAME` — название страны из справочника
*   `TNVED2_NAME` — название двухзначного кода TNVED
*   `TNVED4_NAME` — название четырехзначного кода TNVED
*   `TNVED6_NAME` — название шестизначного кода TNVED
*   `TNVED8_NAME` — название восьмизначного кода TNVED
*   `TNVED_NAME` — название полного кода TNVED (10 знаков)
*   `period_rank` — порядковый номер записи по периоду для каждой страны (1 = самый последний месяц)

### Производительность

*   Скрипт использует режим только чтения для подключения к базе данных, что безопасно и не блокирует другие операции.
*   При извлечении всех комбинаций данные группируются эффективно с использованием polars.
*   Запись в CSV выполняется через оптимизированные методы polars.

### Обработка ошибок

При возникновении ошибок скрипт:
*   Логирует подробное сообщение об ошибке
*   Корректно закрывает соединение с базой данных
*   Завершает работу с соответствующим кодом возврата

## Использование результатов

Извлеченные CSV файлы содержат полную информацию с названиями стран и кодов TNVED, что делает их готовыми к использованию без необходимости дополнительных JOIN'ов со справочниками.

**Преимущества использования enriched view:**
*   **Готовность к анализу**: Данные уже содержат читаемые названия, не требуется дополнительных справочников
*   **Удобство для отчетов**: Названия стран и товарных категорий включены в данные
*   **Фильтрация по периодам**: Колонка `period_rank` позволяет легко фильтровать последние N месяцев для каждой страны

**Применение:**
*   Детальный анализ торговли по конкретным товарным группам
*   Создание специализированных дашбордов в Superset или других инструментах
*   Экспорт данных для дальнейшей обработки в R, Python или других инструментах
*   Создание отчетов по конкретным странам или товарным категориям
*   Передача данных коллегам без необходимости доступа к базе данных

## Связь с другими скриптами

Скрипт работает с результатами работы `merge_processed_data.py`, который создает базу данных `unified_trade_data.duckdb`. Убедитесь, что база данных актуальна перед запуском скрипта извлечения.

