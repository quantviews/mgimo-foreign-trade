# Документация для `extract_country_tnved2_slice.py`

Этот документ описывает работу скрипта `extract_country_tnved2_slice.py`, который предназначен для извлечения срезов данных из итоговой базы данных по стране и коду ТН ВЭД (2- или 4-значный), с опциональной фильтрацией по году и расширенной поддержкой оригинальных турецких наименований.

## Описание

Скрипт `extract_country_tnved2_slice.py` позволяет извлекать данные из базы данных `unified_trade_data.duckdb` с фильтрацией:
- по стране (ISO2 код, колонка `STRANA`);
- по двухзначному коду TNVED (`TNVED2`);
- по четырехзначному коду TNVED (`TNVED4`, приоритет над `TNVED2`);
- по году (`PERIOD` ≥ заданного года).

Извлеченные данные сохраняются в формате **CSV** или **Excel** в папку `data_interim_csv/` (по умолчанию) либо в пользовательскую директорию.

Скрипт использует представление **`unified_trade_data_enriched`**, которое включает названия стран и кодов TNVED, что делает извлеченные данные более информативными и удобными для анализа. Для обработки данных используется библиотека **polars**, что обеспечивает высокую производительность.

Скрипт поддерживает различные режимы работы: извлечение конкретного среза, всех кодов для страны, всех стран для кода, всех комбинаций, а также срезы по 4‑значным кодам.

## Логика работы скрипта

Скрипт выполняет следующие шаги:

1. **Подключение к базе данных**: Скрипт подключается к базе данных `db/unified_trade_data.duckdb` в режиме только чтения (`read_only=True`).

2. **Построение SQL-запроса**: 
   - Базовый запрос выбирает все данные из представления `unified_trade_data_enriched`, которое включает:
     - Все колонки из основной таблицы `unified_trade_data`
     - Названия стран (`COUNTRY_NAME`)
     - Названия кодов TNVED разных уровней (`TNVED2_NAME`, `TNVED4_NAME`, `TNVED6_NAME`, `TNVED8_NAME`, `TNVED_NAME`)
     - Ранжирование по периодам (`period_rank`)
   - В зависимости от переданных аргументов добавляются условия фильтрации:
     - Если указан `--country`, добавляется условие `STRANA = ?` (значение приводится к верхнему регистру)
     - Если указан `--tnved4`, добавляется условие `TNVED4 = ?`, при этом код дополняется ведущими нулями до 4 знаков, и дополнительно добавляется согласованный фильтр по `TNVED2` (первые 2 знака из `TNVED4`)
     - Иначе, если указан `--tnved2`, добавляется условие `TNVED2 = ?` (код дополняется ведущими нулями до 2 знаков)
     - Если указан `--year`, добавляется условие `EXTRACT(YEAR FROM PERIOD) >= ?`

3. **Выполнение запроса и преобразование данных**:
   - Запрос выполняется через DuckDB connection (с параметрами)
   - Результат сначала считывается в pandas DataFrame, затем преобразуется в polars DataFrame для эффективной обработки и записи

4. **Добавление оригинальных турецких названий (опционально)**:
   - Если явно задана страна `TR` и передан `project_root` (в обычном CLI‑режиме он всегда задан), загружаются оригинальные турецкие наименования из JSON файлов в директории `data_raw/turkey/hs_codes_json/` с помощью функции `load_turkey_original_names`
   - Файлы ожидаются в формате `turkey_codes*.json` с маппингом `HS8 → название`
   - Для каждой строки извлеченного набора:
     - из 10‑значного кода `TNVED` берутся первые 8 знаков (`hs8_code`)
     - по `hs8_code` поднимается оригинальное турецкое название
   - Добавляется новая колонка:
     - `TNVED_NAME_ORIGINAL_TURKEY` — оригинальное турецкое наименование для HS8 (если найдено, иначе пустая строка)

5. **Сохранение результатов**:
   - В зависимости от режима работы создаются один или несколько файлов в формате **CSV** или **Excel**:
     - **Режим 1 (одна страна + код)**: указаны `--country` и ( `--tnved4` **или** `--tnved2` ) → создается один файл:
       - при `--tnved4`: `{COUNTRY}_TNVED4_{CODE4}[_from_YEAR].{ext}`
       - при `--tnved2`: `{COUNTRY}_TNVED2_{CODE2}[_from_YEAR].{ext}`
     - **Режим 2 (одна страна, без кода)**: указана только `--country` → создается отдельный файл для каждого кода `TNVED2`:
       - `{COUNTRY}_TNVED2_{CODE2}.{ext}`
     - **Режим 3 (один код, без страны)**: указан только `--tnved2` → создается отдельный файл для каждой страны:
       - `{COUNTRY}_TNVED2_{CODE2}.{ext}`
     - **Режим 4 (ни страна, ни код не указаны)**: создается отдельный файл для каждой комбинации страна-код `TNVED2`:
       - `{COUNTRY}_TNVED2_{CODE2}.{ext}`
   - Расширение файла определяется аргументом `--format`:
     - `csv` → `.csv`
     - `excel` → `.xlsx`
   - По умолчанию все файлы сохраняются в папку `data_interim_csv/` (создается автоматически, если не существует).

6. **Логирование**: В процессе работы скрипт выводит подробную информацию о:
   - Пути к базе данных и выходной директории
   - Применяемых фильтрах (`country`, `tnved2`, `tnved4`, `year`, формат)
   - Количестве извлеченных строк
   - Путях к созданным файлам

## Как запустить скрипт

Скрипт запускается из командной строки и поддерживает несколько аргументов для управления процессом извлечения.

### Аргументы командной строки

*   `--country <ISO-код>` (опциональный): Двухбуквенный ISO-код страны для фильтрации (например, `CN`, `IN`, `TR`). Если не указан, извлекаются данные для всех стран.
*   `--tnved2 <код>` (опциональный): Двухзначный код TNVED для фильтрации (например, `01`, `27`, `87`). Если не указан (и не указан `--tnved4`), извлекаются данные для всех кодов.
*   `--tnved4 <код>` (опциональный): Четырехзначный код TNVED для фильтрации (например, `2710`). Если указан, **переопределяет** `--tnved2` и дополнительно ограничивает выборку согласованным `TNVED2`.
*   `--year <год>` (опциональный): Год, начиная с которого нужно извлекать данные (фильтрация по условию `PERIOD >= 1 января указанного года`).
*   `--db-path <путь>` (опциональный): Путь к базе данных `unified_trade_data.duckdb`. По умолчанию: `db/unified_trade_data.duckdb` относительно корня проекта.
*   `--output-dir <путь>` (опциональный): Директория для сохранения файлов. По умолчанию: `data_interim_csv` относительно корня проекта.
*   `--format {csv,excel}` (опциональный): Формат выходных файлов: `csv` (по умолчанию) или `excel` (генерируются `.xlsx` файлы).

### Примеры использования

**1. Извлечь конкретный срез (страна + двухзначный код):**
```bash
python src/extract_country_tnved2_slice.py --country CN --tnved2 27
```
Создаст файл `CN_TNVED2_27.csv` с данными по Китаю для кода TNVED 27 (топливо, минеральные масла и продукты их перегонки).

**2. Извлечь конкретный срез (страна + четырехзначный код):**
```bash
python src/extract_country_tnved2_slice.py --country TR --tnved4 2710 --year 2024
```
Создаст файл `TR_TNVED4_2710_from_2024.csv` с данными по Турции для кода `2710` начиная с 2024 года.

**3. Извлечь все коды для конкретной страны:**
```bash
python src/extract_country_tnved2_slice.py --country CN
```
Создаст отдельные CSV файлы для каждого двухзначного кода TNVED, присутствующего в данных по Китаю: `CN_TNVED2_01.csv`, `CN_TNVED2_02.csv`, и т.д.

**4. Извлечь все страны для конкретного кода:**
```bash
python src/extract_country_tnved2_slice.py --tnved2 27
```
Создаст отдельные CSV файлы для каждой страны, имеющей данные по коду 27: `CN_TNVED2_27.csv`, `IN_TNVED2_27.csv`, и т.д.

**5. Извлечь все комбинации (создаст отдельные файлы для каждой пары страна-код):**
```bash
python src/extract_country_tnved2_slice.py
```
Создаст CSV файлы для всех возможных комбинаций страна-код, присутствующих в базе данных.

**6. Использование с указанием путей и формата:**
```bash
python src/extract_country_tnved2_slice.py \
  --country TR \
  --tnved2 87 \
  --year 2024 \
  --db-path /path/to/db.duckdb \
  --output-dir /path/to/output \
  --format excel
```
Создаст файл `TR_TNVED2_87_from_2024.xlsx` в указанной директории.

## Технические детали

### Использование polars

Скрипт использует библиотеку **polars** для обработки данных, что обеспечивает:
*   Высокую производительность при работе с большими объемами данных
*   Эффективную фильтрацию и группировку данных
*   Оптимизированную запись в CSV и Excel форматы

### Нормализация кодов

*   **Коды стран**: Все коды стран приводятся к верхнему регистру (`CN`, `IN`, `TR`).
*   **Коды TNVED2**: Коды дополняются ведущими нулями до 2 знаков (`1` → `01`, `27` → `27`).
*   **Коды TNVED4**: Коды дополняются ведущими нулями до 4 знаков (`271` → `0271`, `2710` → `2710`).

### Обработка пустых результатов

Если запрос не вернул данных (например, указанная комбинация страна-код/год отсутствует в базе), скрипт выводит предупреждение и завершает работу без создания файла.

### Структура выходных файлов

Выходные файлы (CSV или Excel) содержат все колонки из представления `unified_trade_data_enriched`, а при необходимости — и дополнительные колонки, включая:

**Основные колонки данных:**
*   `NAPR` — направление торговли (ИМ/ЭК)
*   `PERIOD` — отчетный период (дата)
*   `STRANA` — страна-отчет (ISO код)
*   `TNVED` — код ТН ВЭД (10 знаков)
*   `TNVED2`, `TNVED4`, `TNVED6`, `TNVED8` — производные коды разных уровней
*   `EDIZM` — единица измерения
*   `EDIZM_ISO` — ISO код единицы измерения
*   `STOIM` — стоимость в тысячах USD
*   `NETTO` — вес нетто в кг
*   `KOL` — количество в дополнительной единице

**Дополнительные колонки из enriched view:**
*   `COUNTRY_NAME` — название страны из справочника
*   `TNVED2_NAME` — название двухзначного кода TNVED
*   `TNVED4_NAME` — название четырехзначного кода TNVED
*   `TNVED6_NAME` — название шестизначного кода TNVED
*   `TNVED8_NAME` — название восьмизначного кода TNVED
*   `TNVED_NAME` — название полного кода TNVED (10 знаков)
*   `period_rank` — порядковый номер записи по периоду для каждой страны (1 = самый последний месяц)

**Дополнительные колонки (для Турции):**
*   `TNVED_NAME_ORIGINAL_TURKEY` — оригинальное турецкое наименование для 8‑значного кода (добавляется, если `country = TR` и найдены JSON‑файлы с кодами Турции)

### Производительность

*   Скрипт использует режим только чтения для подключения к базе данных, что безопасно и не блокирует другие операции.
*   При извлечении всех комбинаций данные группируются эффективно с использованием polars.
*   Запись в CSV выполняется через оптимизированные методы polars.

### Обработка ошибок

При возникновении ошибок скрипт:
*   Логирует подробное сообщение об ошибке
*   Корректно закрывает соединение с базой данных
*   Завершает работу с соответствующим кодом возврата

## Использование результатов

Извлеченные CSV файлы содержат полную информацию с названиями стран и кодов TNVED, что делает их готовыми к использованию без необходимости дополнительных JOIN'ов со справочниками.

**Преимущества использования enriched view:**
*   **Готовность к анализу**: Данные уже содержат читаемые названия, не требуется дополнительных справочников
*   **Удобство для отчетов**: Названия стран и товарных категорий включены в данные
*   **Фильтрация по периодам**: Колонка `period_rank` позволяет легко фильтровать последние N месяцев для каждой страны

**Применение:**
*   Детальный анализ торговли по конкретным товарным группам
*   Создание специализированных дашбордов в Superset или других инструментах
*   Экспорт данных для дальнейшей обработки в R, Python или других инструментах
*   Создание отчетов по конкретным странам или товарным категориям
*   Передача данных коллегам без необходимости доступа к базе данных

## Связь с другими скриптами

Скрипт работает с результатами работы `merge_processed_data.py`, который создает базу данных `unified_trade_data.duckdb`. Убедитесь, что база данных актуальна перед запуском скрипта извлечения.

