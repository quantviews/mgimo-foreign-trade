# Документация и логика работы `china-collector.py`

## 1. Назначение скрипта

Скрипт `china-collector.py` предназначен для полуавтоматического сбора и первичной обработки данных по внешней торговле с сайта таможенной статистики Китая ([http://stats.customs.gov.cn/indexEn](http://stats.customs.gov.cn/indexEn)).

Поскольку сайт защищен от полностью автоматического сбора данных с помощью CAPTCHA, скрипт автоматизирует только часть процесса, оставляя пользователю ручное выполнение шагов, требующих ручного вмешательства.

## 2. Логика работы (Workflow)

Процесс сбора данных разделен на два этапа: ручной (выполняется пользователем) и автоматический (выполняется скриптом).

### Шаг 1: Запуск и ручной сбор данных

1.  **Запуск скрипта:** Пользователь запускает скрипт из командной строки, указывая год, месяц и направление торгового потока (`ИМ` для импорта, `ЭК` для экспорта).

    ```bash
    python src/collectors/china-collector.py 2025 7 ИМ --partner 344
    ```

2.  **Открытие браузера:** Скрипт автоматически открывает браузер Google Chrome и переходит на сайт таможенной статистики КНР. Для обхода базовой защиты от ботов используются "стелс-опции", которые маскируют автоматизированный браузер под обычный.

3.  **Действия пользователя:** В открывшемся окне браузера пользователь должен вручную:
    *   Заполнить форму, выбрав необходимые параметры (торговый поток, период, страну-партнера (РФ = 344 и т.д.). Обязательно нужно выбрать также валюту (US Dollar).
    *   Нажать кнопку "Enquiry".
    *   Пройти проверку CAPTCHA (слайдер).
    *   На странице с результатами нажать кнопку "Download", чтобы скачать файл `downloadData.csv`.

4.  **Завершение ручного этапа:** После того как файл `downloadData.csv` полностью скачан, пользователь возвращается в окно терминала и нажимает клавишу `Enter`.

### Шаг 2: Автоматическая обработка

После нажатия `Enter` скрипт продолжает работу автоматически:

1.  **Перемещение и сохранение сырых данных:** Скрипт находит файл `downloadData.csv` в папке "Загрузки" и перемещает его в соответствующую директорию проекта (`data_raw/china/IMPORT` или `data_raw/china/EXPORT`). Файл переименовывается для удобства отслеживания (например, `raw_202507_ИМ.csv`).

2.  **Проверка качества сырых данных (`run_raw_data_checks`):**
    *   Скрипт открывает сырой CSV-файл и проверяет его на соответствие ожидаемому формату.
    *   **Проверка колонок:** Убеждается в наличии ключевых столбцов (`Date of data`, `Commodity code`, `Quantity` и др.).
    *   **Проверка формата даты:** Проверяет, что `Date of data` имеет формат `YYYYMM`.
    *   **Проверка числовых значений:** Убеждается, что колонка `Quantity` содержит только цифры.
    *   Если проверка не пройдена, скрипт останавливается с сообщением об ошибке.

3.  **Обработка и трансформация данных:**
    *   Данные из сырого файла загружаются в DataFrame `pandas`.
    *   Колонки переименовываются в соответствии с принятым в проекте стандартом (например, `Commodity code` -> `TNVED`, `US dollar` -> `STOIM`).
    *   Лишние столбцы удаляются.
    *   Создаются новые столбцы с кодами ТН ВЭД разного уровня детализации (`TNVED2`, `TNVED4`, `TNVED6`).
    *   Торговый поток "отзеркаливается" с точки зрения России (например, импорт Китая из России (`ИМ`) становится экспортом России в Китай (`ЭК`)).

4.  **Сохранение обработанного файла:** Финальный, очищенный DataFrame сохраняется в ту же директорию в формате CSV с именем, отражающим год и месяц (например, `data202507.csv`).

## 3. Использование

### Требования

-   Установленный Python и `pip`.
-   Активированное окружение `conda` (`mgimo_trade`).
-   Установленный браузер Google Chrome.

### Установка зависимостей

```bash
pip install pandas selenium webdriver-manager
```

### Команда для запуска

```bash
python src/collectors/china-collector.py <год> <месяц> <поток> [--partner <код_партнера>] [--output_dir <путь>]
```

**Аргументы:**
-   `year`: Год данных (например, `2025`).
-   `month`: Месяц данных (например, `7` или `07`).
-   `flow`: Торговый поток. `ИМ` для импорта Китая (экспорт из РФ), `ЭК` для экспорта Китая (импорт в РФ).
-   `--partner` (опционально): Код страны-партнера. По умолчанию `344` (Россия).
-   `--output_dir` (опционально): Путь для сохранения файлов. По умолчанию `data_raw/china`.
