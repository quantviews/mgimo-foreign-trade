# Документация и логика работы `china-collector.py`

## 1. Назначение скрипта

Скрипт `china-collector.py` предназначен для полуавтоматического сбора сырых данных по внешней торговле с сайта таможенной статистики Китая ([http://stats.customs.gov.cn/indexEn](http://stats.customs.gov.cn/indexEn)).

Поскольку сайт защищен от полностью автоматического сбора данных с помощью CAPTCHA, скрипт автоматизирует только часть процесса, оставляя пользователю ручное выполнение шагов, требующих ручного вмешательства.

**Важно:** Данный скрипт только собирает и сохраняет сырые данные. Для обработки данных используйте отдельный скрипт `china_processor.py`.

## 2. Логика работы (Workflow)

Процесс сбора данных разделен на два этапа: ручной (выполняется пользователем) и автоматический (выполняется скриптом).

### Шаг 1: Запуск и ручной сбор данных

1.  **Запуск скрипта:** Пользователь запускает скрипт из командной строки, указывая год, месяц и направление торгового потока (`ИМ` для импорта, `ЭК` для экспорта).

    ```bash
    python src/collectors/china-collector.py 2025 7 ИМ --partner 344
    ```

2.  **Открытие браузера:** Скрипт автоматически открывает браузер Google Chrome и переходит на сайт таможенной статистики КНР. Для обхода базовой защиты от ботов используются "стелс-опции", которые маскируют автоматизированный браузер под обычный.

3.  **Действия пользователя:** В открывшемся окне браузера пользователь должен вручную:
    *   Заполнить форму, выбрав необходимые параметры (торговый поток, период, страну-партнера (РФ = 344 и т.д.). Обязательно нужно выбрать также валюту (US Dollar).
    *   Нажать кнопку "Enquiry".
    *   Пройти проверку CAPTCHA (слайдер).
    *   На странице с результатами нажать кнопку "Download", чтобы скачать файл `downloadData.csv`.

4.  **Завершение ручного этапа:** После того как файл `downloadData.csv` полностью скачан, пользователь возвращается в окно терминала и нажимает клавишу `Enter`.

### Шаг 2: Автоматическое сохранение сырых данных

После нажатия `Enter` скрипт продолжает работу автоматически:

1.  **Перемещение и сохранение сырых данных:** Скрипт находит файл `downloadData.csv` в папке "Загрузки" и перемещает его в соответствующую директорию проекта (`data_raw/china/IMPORT` или `data_raw/china/EXPORT`). Файл переименовывается в формат `data{год}{месяц}.csv` (например, `data202507.csv`).

2.  **Проверка качества сырых данных (`run_raw_data_checks`):**
    *   Скрипт открывает сырой CSV-файл и проверяет его на соответствие ожидаемому формату.
    *   **Проверка колонок:** Убеждается в наличии ключевых столбцов (`Date of data`, `Commodity code`, `Quantity` и др.).
    *   **Проверка формата даты:** Проверяет, что `Date of data` имеет формат `YYYYMM`.
    *   **Проверка числовых значений:** Убеждается, что колонка `Quantity` содержит только цифры.
    *   Если проверка не пройдена, скрипт останавливается с сообщением об ошибке.

3.  **Завершение:** После успешной проверки скрипт завершает работу. Сырые данные готовы для обработки с помощью `china_processor.py`.

## 3. Использование

### Требования

-   Установленный Python и `pip`.
-   Активированное окружение `conda` (`mgimo_trade`).
-   Установленный браузер Google Chrome.

### Установка зависимостей

```bash
pip install pandas selenium webdriver-manager undetected-chromedriver
```

### Команда для запуска

```bash
python src/collectors/china-collector.py <год> <месяц> <поток> [--partner <код_партнера>] [--output_dir <путь>]
```

**Аргументы:**
-   `year`: Год данных (например, `2025`).
-   `month`: Месяц данных (например, `7` или `07`).
-   `flow`: Торговый поток. `ИМ` для импорта Китая (экспорт из РФ), `ЭК` для экспорта Китая (импорт в РФ).
-   `--partner` (опционально): Код страны-партнера. По умолчанию `344` (Россия).
-   `--output_dir` (опционально): Путь для сохранения файлов. По умолчанию `data_raw/china`.

### Примеры использования

1. **Сбор данных за июль 2025 года (импорт Китая):**
   ```bash
   python src/collectors/china-collector.py 2025 7 ИМ --partner 344
   ```

2. **Обработка собранных сырых данных:**
   ```bash
   python src/collectors/china_processor.py 
   ```

### Полный рабочий процесс

1. **Сбор сырых данных:**
   ```bash
   python src/collectors/china-collector.py 2025 7 ИМ --partner 344
   ```

2. **Обработка данных:**
   ```bash
   python src/collectors/china_processor.py data_raw/china/EXPORT/data202507.csv 2025 07 ИМ
   ```

## 4. Связанные файлы

- **`china_processor.py`**: Скрипт для обработки сырых данных, собранных с помощью `china-collector.py`
- **`data_raw/china/`**: Директория для хранения сырых данных
