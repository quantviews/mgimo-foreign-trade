# Документация для `china-collector.py`

Этот документ описывает работу скрипта `china-collector.py`, его полуавтоматическую логику и способы использования для сбора данных о внешней торговле Китая.

## Описание

Скрипт `china-collector.py` предназначен для сбора данных о внешней торговле Китая с официального портала Таможенной службы Китая (`http://stats.customs.gov.cn/indexEn`).

Из-за наличия сложной CAPTCHA, которую необходимо решать вручную, скрипт работает в **полуавтоматическом режиме**. Он автоматизирует открытие браузера и подготовку к загрузке, но требует участия пользователя для решения CAPTCHA и скачивания файла.

## Логика работы скрипта

Скрипт выполняет следующие шаги:

1.  **Запуск браузера**: Скрипт открывает браузер Chrome в специальном режиме (`undetected-chromedriver`), чтобы избежать обнаружения системами защиты от ботов, и переходит на сайт таможенной статистики Китая.
2.  **Действия пользователя (вручную)**:
    *   На открывшейся странице пользователь должен **самостоятельно** заполнить форму: выбрать год, месяц, направление торговли (импорт/экспорт) и страну-партнера.
    *   После этого необходимо решить CAPTCHA.
    *   Нажать на кнопку для скачивания данных. Файл по умолчанию сохраняется как `downloadData.csv` в стандартную папку "Загрузки".
3.  **Ожидание файла**: После того как пользователь скачал файл, он должен вернуться в терминал, где запущен скрипт, и нажать `Enter`. Скрипт будет ожидать появления файла `downloadData.csv` в папке "Загрузки".
4.  **Валидация файла**: Как только файл обнаружен, скрипт проводит несколько проверок:
    *   **Проверка колонок**: Убеждается, что в файле присутствуют все необходимые колонки (`Date of data`, `Commodity code` и т.д.).
    *   **Проверка даты**: Сравнивает дату из колонки `Date of data` с годом и месяцем, указанными при запуске скрипта.
    *   **Проверка валюты**: Проверяет, что данные выгружены в долларах США (`US dollar`), а не в юанях.
    *   Если любая из проверок не проходит, скрипт выводит сообщение об ошибке, удаляет некорректный файл и завершает работу.
5.  **Обработка данных**: Если все проверки пройдены, скрипт:
    *   Переименовывает колонки в соответствии с моделью данных проекта (`TNVED`, `STOIM`, `NETTO` и т.д.).
    *   "Отзеркаливает" направление торговли (`NAPR`) для соответствия российской перспективе (китайский импорт становится экспортом для России и наоборот).
    *   Создает дополнительные столбцы (`TNVED2`, `TNVED4`, `TNVED6`).
6.  **Сохранение результата**: Обработанный файл сохраняется в директорию `data_raw/china/`, в подпапку `IMPORT` или `EXPORT` в зависимости от итогового направления потока.
7.  **Очистка**: Исходный файл `downloadData.csv` удаляется из папки "Загрузки".

## Как запустить скрипт

### Требования
*   Установленный браузер Google Chrome.

### Порядок действий

1.  Откройте терминал и перейдите в корневую директорию проекта.
2.  Запустите скрипт, указав обязательные аргументы: `год`, `месяц` и `направление`.

    ```bash
    python src/collectors/china-collector.py <год> <месяц> <направление> [--partner <код_партнера>]
    ```
3.  Скрипт откроет окно браузера. **Вручную** заполните форму на сайте, решите CAPTCHA и скачайте файл.
4.  Вернитесь в терминал и нажмите `Enter`.
5.  Скрипт обработает файл и сохранит результат.

### Аргументы командной строки

*   `year` (обязательный): Год данных (например, `2025`).
*   `month` (обязательный): Месяц данных (например, `8` или `08`).
*   `flow` (обязательный): Направление торговли с точки зрения Китая. Принимает значения `ИМ` (импорт) или `ЭК` (экспорт).
*   `--partner` (опциональный): Код страны-партнера. По умолчанию `344` (Россия).

### Пример использования

Для сбора данных по **импорту Китая** из России за **Август 2025 года**:

```bash
python src/collectors/china-collector.py 2025 8 ИМ --partner 344
```
После выполнения этой команды откроется браузер. Вам нужно будет вручную выбрать на сайте `Year: 2025`, `Month: August`, `I/E: Import`, `Partner: Russia`, решить CAPTCHA и скачать файл. Затем вернуться в терминал и нажать `Enter`. В результате будет создан файл в `data_raw/china/EXPORT/`, так как импорт для Китая является экспортом для России.
