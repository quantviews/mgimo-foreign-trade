# Документация для `outlier_detection.py`

Этот документ описывает работу модуля `outlier_detection.py`, который предназначен для обнаружения и обработки выбросов в данных о внешней торговле, хранящихся в базе данных DuckDB.

## Описание

Модуль `outlier_detection.py` является отдельным инструментом для анализа и обработки выбросов в колонке `KOL` (количество в дополнительной единице измерения) в объединенной базе данных `unified_trade_data.duckdb`. Модуль работает с уже созданной базой данных и может быть запущен независимо от процесса объединения данных.

Модуль использует статистические методы на основе z-score для обнаружения аномальных значений в временных рядах данных, группируя записи по комбинации страна-товар-направление торговли (STRANA, TNVED, NAPR).

## Логика работы модуля

Модуль выполняет следующие шаги:

1. **Подключение к базе данных**: Модуль подключается к указанной базе данных DuckDB (по умолчанию `db/unified_trade_data.duckdb`) и проверяет наличие таблицы `unified_trade_data`.

2. **Загрузка данных**: Из базы данных загружаются все записи, содержащие значения в колонке `KOL` (не NULL), включая необходимые колонки: `STRANA`, `TNVED`, `NAPR`, `PERIOD`, `KOL`, `STOIM`, `NETTO`.

3. **Обнаружение выбросов по временным рядам**: Данные группируются по комбинации `STRANA`, `TNVED`, `NAPR` (каждая группа представляет отдельный временной ряд). Для каждого временного ряда применяются три независимых метода обнаружения выбросов:
   - **Метод 1**: Выбросы в абсолютных значениях `KOL`
   - **Метод 2**: Выбросы в отношении `KOL/STOIM`
   - **Метод 3**: Выбросы в отношении `KOL/NETTO`
   
   Временной ряд считается содержащим выбросы если:
   - **Метод 1** обнаружил хотя бы один выброс (это основной метод, и его обнаружение достаточно для учета ряда)
   - ИЛИ **все три метода** обнаружили хотя бы один выброс
   
   Это менее строгий критерий, который позволяет обнаруживать выбросы даже в случаях, когда методы 2 или 3 не могут сработать (например, когда `STOIM` или `NETTO` равны нулю или NULL).

4. **Замена выбросов на NULL (опционально)**: Если указан параметр `replace_outliers=True` (по умолчанию), модуль обновляет базу данных, заменяя обнаруженные выбросы на `NULL` в колонке `KOL`. Обновление выполняется через SQL-запросы `UPDATE` для каждой обнаруженной записи.

5. **Создание отчетов**: Модуль автоматически создает детальные отчеты о найденных выбросах в папке `reports/`:
   - Детальный отчет в формате CSV
   - Сводная таблица по временным рядам
   - Метаданные в формате JSON

6. **Вывод статистики**: В консоль выводится подробная статистика о процессе обнаружения и обработки выбросов.

## Методология обнаружения выбросов

### Параметры обнаружения

Модуль использует следующие параметры по умолчанию (соответствуют параметрам из R-скрипта `outliers_detection.Rmd`):

- **`nsd = 6.0`** — количество стандартных отклонений (6 сигм). Значение считается выбросом, если его z-score превышает 6 стандартных отклонений от среднего.
- **`tv = 1,000,000`** — пороговое значение для `KOL`. Выбросом может быть только значение, превышающее этот порог.

### Три метода обнаружения

#### Метод 1: Выбросы в абсолютных значениях KOL

Для каждого временного ряда вычисляются:
- Среднее значение `KOL`: `mean_kol = mean(KOL)`
- Стандартное отклонение: `std_kol = std(KOL)`
- Z-score для каждого значения: `z_kol = (KOL - mean_kol) / std_kol`

Значение считается выбросом, если:
- `|z_kol| > nsd` (абсолютное значение z-score превышает 6 стандартных отклонений)
- `KOL > tv` (значение превышает порог 1,000,000)

#### Метод 2: Выбросы в отношении KOL/STOIM

Для каждого временного ряда вычисляется отношение `KOL/STOIM` (количество к стоимости):
- Среднее отношение: `mean_ratio = mean(KOL / STOIM)`
- Стандартное отклонение отношения: `std_ratio = std(KOL / STOIM)`
- Z-score для каждого отношения: `z_ratio = (ratio - mean_ratio) / std_ratio`

Значение считается выбросом, если:
- `|z_ratio| > nsd` (отношение отклоняется более чем на 6 стандартных отклонений)
- `KOL > tv` (исходное значение KOL превышает порог 1,000,000)

**Примечание**: Метод применяется только к записям, где `STOIM` не равно нулю и не NULL.

#### Метод 3: Выбросы в отношении KOL/NETTO

Аналогично методу 2, но для отношения `KOL/NETTO` (количество к весу):
- Среднее отношение: `mean_ratio = mean(KOL / NETTO)`
- Стандартное отклонение отношения: `std_ratio = std(KOL / NETTO)`
- Z-score для каждого отношения: `z_ratio = (ratio - mean_ratio) / std_ratio`

Значение считается выбросом, если:
- `|z_ratio| > nsd` (отношение отклоняется более чем на 6 стандартных отклонений)
- `KOL > tv` (исходное значение KOL превышает порог 1,000,000)

**Примечание**: Метод применяется только к записям, где `NETTO` не равно нулю и не NULL.

### Критерий выброса временного ряда

Временной ряд (группа записей с одинаковыми `STRANA`, `TNVED`, `NAPR`) считается содержащим выбросы если выполняется одно из условий:

1. **Метод 1 (KOL) обнаружил выбросы** (`outliers_1 >= 1`) — это основной метод, и его обнаружение достаточно для учета ряда, даже если методы 2 и 3 не сработали.

2. **Все три метода обнаружили выбросы** (`outliers_1 >= 1` И `outliers_2 >= 1` И `outliers_3 >= 1`) — это подтверждает наличие выбросов всеми методами.

**Обоснование менее строгого критерия:**
- Методы 2 и 3 могут не сработать, если `STOIM` или `NETTO` равны нулю или NULL
- Методы 2 и 3 могут не обнаружить выбросы, если соотношения `KOL/STOIM` или `KOL/NETTO` не выходят за пределы, даже при очень больших абсолютных значениях `KOL`
- Метод 1 (абсолютные значения `KOL`) является наиболее надежным и универсальным методом обнаружения выбросов

Этот подход обеспечивает обнаружение явных выбросов в абсолютных значениях, которые могут быть пропущены при строгом требовании всех трех методов.

### Замена выбросов

После обнаружения временных рядов с выбросами, модуль повторно применяет логику трех методов к каждому ряду для определения конкретных записей-выбросов. Логика замены зависит от того, какие методы обнаружили выбросы в ряду:

1. **Если все три метода обнаружили выбросы** — заменяются только те записи, которые обнаружены **всеми тремя методами одновременно** (пересечение всех трех методов). Это обеспечивает высокую точность замены.

2. **Если только метод 1 обнаружил выбросы** — заменяются все записи, которые обнаружены методом 1. Это важно для случаев, когда методы 2 и 3 не могут сработать (например, из-за нулевых значений `STOIM` или `NETTO`).

Обнаруженные выбросы заменяются на `NULL` в колонке `KOL` через SQL-запросы:
```sql
UPDATE unified_trade_data
SET KOL = NULL
WHERE STRANA = ? AND TNVED = ? AND NAPR = ? AND PERIOD = ? AND KOL IS NOT NULL
```

## Использование

### Запуск из командной строки

```bash
python src/outlier_detection.py [опции]
```

### Аргументы командной строки

| Аргумент | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `--db-path` | строка | `db/unified_trade_data.duckdb` | Путь к файлу базы данных DuckDB |
| `--nsd` | float | `6.0` | Количество стандартных отклонений для определения выброса |
| `--tv` | float | `1e6` | Пороговое значение для KOL (1,000,000) |
| `--keep-outliers` | флаг | `False` | Если указан, выбросы обнаруживаются, но не заменяются на NULL |
| `--reports-dir` | строка | `reports/` | Директория для сохранения отчетов |

### Примеры использования

#### Базовое использование (обнаружение и замена выбросов)

```bash
python src/outlier_detection.py
```

Этот команда:
- Подключится к базе данных `db/unified_trade_data.duckdb`
- Обнаружит выбросы с параметрами `nsd=6.0`, `tv=1e6`
- Заменит выбросы на NULL в базе данных
- Создаст отчеты в папке `reports/`

#### Обнаружение без замены

```bash
python src/outlier_detection.py --keep-outliers
```

Эта команда обнаружит выбросы и создаст отчеты, но не будет изменять базу данных.

#### Использование другой базы данных

```bash
python src/outlier_detection.py --db-path /path/to/other_database.duckdb
```

#### Изменение параметров обнаружения

```bash
python src/outlier_detection.py --nsd 5.0 --tv 500000
```

Эта команда использует более мягкие критерии обнаружения (5 стандартных отклонений вместо 6, порог 500,000 вместо 1,000,000).

#### Указание директории для отчетов

```bash
python src/outlier_detection.py --reports-dir /path/to/custom/reports
```

### Использование как модуль Python

Модуль также может быть импортирован и использован в других скриптах:

```python
from pathlib import Path
from outlier_detection import process_outliers_in_db

# Обработка выбросов
results = process_outliers_in_db(
    db_path=Path('db/unified_trade_data.duckdb'),
    nsd=6.0,
    tv=1e6,
    replace_outliers=True,
    reports_dir=Path('reports')
)

print(f"Найдено временных рядов с выбросами: {results['outlier_series_count']}")
print(f"Заменено выбросов: {results['replaced_count']}")
```

## Структура отчетов

Модуль создает три файла отчета в указанной директории (по умолчанию `reports/`):

### 1. Детальный отчет (`outliers_detailed_YYYYMMDD_HHMMSS.csv`)

Содержит информацию о каждом обнаруженном выбросе:

| Колонка | Описание |
|---------|----------|
| `STRANA` | ISO-код страны |
| `TNVED` | Код товара (TNVED) |
| `NAPR` | Направление торговли (ИМ/ЭК) |
| `PERIOD` | Отчетный период |
| `KOL` | Значение KOL (выброс) |
| `STOIM` | Значение STOIM |
| `NETTO` | Значение NETTO |
| `KOL_Mean` | Среднее значение KOL в временном ряду |
| `KOL_Std` | Стандартное отклонение KOL в временном ряду |
| `Z_Score_KOL` | Z-score для значения KOL |
| `Detection_Methods` | Методы, которыми обнаружен выброс (KOL, KOL/STOIM, KOL/NETTO) |
| `Outliers_Method1` | Количество выбросов по методу 1 в этом ряду |
| `Outliers_Method2` | Количество выбросов по методу 2 в этом ряду |
| `Outliers_Method3` | Количество выбросов по методу 3 в этом ряду |
| `Total_Outliers_in_Series` | Общее количество выбросов во всех методах для этого ряда |

### 2. Сводная таблица (`outliers_summary_YYYYMMDD_HHMMSS.csv`)

Содержит сводную информацию по каждому временному ряду с выбросами:

| Колонка | Описание |
|---------|----------|
| `STRANA` | ISO-код страны |
| `TNVED` | Код товара (TNVED) |
| `NAPR` | Направление торговли (ИМ/ЭК) |
| `outliers_1` | Количество выбросов по методу 1 (KOL) |
| `outliers_2` | Количество выбросов по методу 2 (KOL/STOIM) |
| `outliers_3` | Количество выбросов по методу 3 (KOL/NETTO) |

### 3. Метаданные отчета (`outliers_report_YYYYMMDD_HHMMSS.json`)

Содержит метаинформацию о процессе обнаружения:

```json
{
  "timestamp": "20240101_120000",
  "detection_parameters": {
    "nsd": 6.0,
    "tv": 1000000.0,
    "require_all_methods": true
  },
  "summary": {
    "total_time_series_with_outliers": 150,
    "total_outliers_method1": 250,
    "total_outliers_method2": 280,
    "total_outliers_method3": 270,
    "total_outliers_all_methods": 800
  },
  "replacement": {
    "replaced_with_nan": 500,
    "keep_outliers": false
  },
  "detailed_records_count": 500
}
```

## Основные функции модуля

### `show_outliers(x, nsd, tv) -> int`

Подсчитывает количество выбросов в ряде данных на основе z-score.

**Параметры:**
- `x`: pandas Series с данными
- `nsd`: Количество стандартных отклонений
- `tv`: Пороговое значение

**Возвращает:** Количество выбросов

### `outlier_frac(x, y, nsd, tv) -> int`

Подсчитывает количество выбросов в отношении x/y.

**Параметры:**
- `x`: pandas Series (числитель)
- `y`: pandas Series (знаменатель)
- `nsd`: Количество стандартных отклонений
- `tv`: Пороговое значение для x

**Возвращает:** Количество выбросов

### `detect_outliers_by_time_series(df, nsd, tv, require_all_methods) -> pd.DataFrame`

Обнаруживает выбросы в KOL, группируя данные по временным рядам (STRANA, TNVED, NAPR).

**Параметры:**
- `df`: DataFrame с данными
- `nsd`: Количество стандартных отклонений (по умолчанию 6.0)
- `tv`: Пороговое значение (по умолчанию 1e6)
- `require_all_methods`: Если True, возвращает ряды, где метод 1 нашел выбросы ИЛИ все три метода нашли выбросы (по умолчанию True). Если метод 1 нашел выбросы, ряд учитывается даже если методы 2 и 3 не сработали.

**Возвращает:** DataFrame с колонками STRANA, TNVED, NAPR, outliers_1, outliers_2, outliers_3

### `process_outliers_in_db(db_path, nsd, tv, replace_outliers, reports_dir) -> Dict`

Основная функция для обработки выбросов в базе данных DuckDB.

**Параметры:**
- `db_path`: Path к файлу базы данных DuckDB
- `nsd`: Количество стандартных отклонений (по умолчанию 6.0)
- `tv`: Пороговое значение для KOL (по умолчанию 1e6)
- `replace_outliers`: Если True, заменяет выбросы на NULL (по умолчанию True)
- `reports_dir`: Директория для сохранения отчетов (по умолчанию None, используется reports/ в корне проекта)

**Возвращает:** Словарь с результатами обработки:
- `outlier_series_count`: Количество временных рядов с выбросами
- `replaced_count`: Количество замененных выбросов
- `outliers_method1`: Общее количество выбросов по методу 1
- `outliers_method2`: Общее количество выбросов по методу 2
- `outliers_method3`: Общее количество выбросов по методу 3

## Взаимодействие с базой данных

Модуль работает с базой данных DuckDB в режиме записи (`read_only=False`), что позволяет обновлять значения в таблице `unified_trade_data`. 

**Важно**: Модуль изменяет данные в базе, заменяя выбросы на NULL. Рекомендуется:
- Создавать резервную копию базы данных перед обработкой выбросов
- Использовать флаг `--keep-outliers` для предварительного анализа без изменений

## Рекомендации по использованию

1. **Первый запуск**: Рекомендуется сначала запустить модуль с флагом `--keep-outliers` для анализа выбросов без изменения данных:
   ```bash
   python src/outlier_detection.py --keep-outliers
   ```

2. **Проверка отчетов**: Изучите созданные отчеты, особенно детальный отчет, чтобы убедиться, что обнаруженные выбросы действительно являются аномалиями.

3. **Замена выбросов**: После проверки запустите модуль без флага `--keep-outliers` для замены выбросов на NULL:
   ```bash
   python src/outlier_detection.py
   ```

4. **Настройка параметров**: Если обнаружено слишком много или слишком мало выбросов, можно настроить параметры `--nsd` и `--tv` для более строгого или более мягкого обнаружения.

5. **Интеграция в pipeline**: Модуль может быть интегрирован в автоматизированный pipeline обработки данных, запускаясь после объединения данных в `merge_processed_data.py`.

## Технические детали

- Модуль использует pandas для обработки данных и duckdb для работы с базой данных
- Обновление базы данных выполняется через параметризованные SQL-запросы для безопасности
- Отчеты сохраняются с временной меткой в имени файла для отслеживания версий
- Все numpy типы преобразуются в нативные Python типы для корректной сериализации в JSON

## Связь с другими модулями

Модуль `outlier_detection.py` является логическим продолжением процесса обработки данных, начатого в `merge_processed_data.py`:

1. `merge_processed_data.py` объединяет данные из различных источников и сохраняет их в `unified_trade_data.duckdb`
2. `outlier_detection.py` анализирует объединенные данные и обрабатывает выбросы

Модули работают независимо, что позволяет:
- Запускать обнаружение выбросов отдельно от процесса объединения
- Повторно запускать обнаружение выбросов с разными параметрами
- Анализировать выбросы без изменения данных

