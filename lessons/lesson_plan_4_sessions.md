# План занятий по внешнеторговой статистике
## Курс: Международные технологические рынки и технологическое лидерство
## МГИМО, магистратура

**Автор:** Марсель Салихов  
**Формат:** 4 занятия по 1 часу 20 минут (80 минут каждое)  
**Аудитория:** Магистранты-международники, прошедшие интенсивы по Python (сентябрь-декабрь)

---

## ЗАНЯТИЕ 1: Введение в таможенную статистику и структуру данных
**Длительность:** 80 минут

### Цели занятия:
- Понять, как устроена таможенная статистика
- Изучить структуру данных проекта
- Познакомиться с основными понятиями (ТН ВЭД, зеркальная статистика, источники данных)

### Структура занятия:

#### Часть 1: Теоретический блок (25 минут)
**1.1. Что такое таможенная статистика? (10 мин)**
- Определение и назначение
- Кто собирает данные: ФТС России, национальные таможенные службы, UN Comtrade
- Основные показатели: стоимость (STOIM), вес нетто (NETTO), количество (KOL)
- Направления торговли: импорт (ИМ) и экспорт (ЭК)

**1.2. Товарная номенклатура ТН ВЭД (10 мин)**
- Что такое ТН ВЭД и зачем она нужна
- Иерархия кодов: TNVED2 (группа), TNVED4 (позиция), TNVED6 (субпозиция), TNVED8-10 (детализация)
- Примеры: `01` (живые животные), `0101` (лошади, ослы, мулы), `010121` (лошади чистокровные)
- Практический пример: найти код для конкретного товара

**1.3. Зеркальная статистика: что это и зачем? (5 мин)**
- Определение: статистика страны-партнера о торговле с РФ
- Почему она важна: когда официальная статистика недоступна
- Источники: национальные таможенные службы (Китай, Индия, Турция), UN Comtrade

#### Часть 2: Структура проекта (20 минут)
**2.1. Обзор проекта "Актуальная статистика внешней торговли" (10 мин)**
- Демонстрация структуры проекта (через файловую систему или презентацию)
- Основные компоненты:
  - `src/collectors/` - сборщики данных (Китай, Индия, Турция)
  - `data_processed/` - обработанные данные в формате Parquet
  - `db/` - база данных DuckDB
  - `superset/` - конфигурация дашборда

**2.2. Модель данных (10 мин)**
- Демонстрация схемы данных из `docs/data_model.md`
- Основные поля:
  - `NAPR` - направление (ИМ/ЭК)
  - `PERIOD` - период (дата)
  - `STRANA` - страна-партнер (ISO2 код)
  - `TNVED`, `TNVED2`, `TNVED4`, `TNVED6` - товарные коды
  - `STOIM` - стоимость в тысячах USD
  - `NETTO` - вес нетто в кг
  - `KOL` - количество в дополнительной единице
  - `EDIZM` - единица измерения
- Пример записи данных

#### Часть 3: Практическая работа (30 минут)
**3.1. Подготовка окружения (5 мин)**
- Проверка установки Python, pandas, duckdb
- Клонирование/открытие проекта
- Настройка рабочей директории

**3.2. Первое знакомство с данными (25 мин)**
- Загрузка данных из DuckDB в pandas DataFrame
- Базовые операции:
  ```python
  import duckdb
  import pandas as pd
  conn = duckdb.connect('db/unified_trade_data.duckdb')
  df = conn.execute("SELECT * FROM unified_trade_data LIMIT 1000").df()
  ```
- Изучение структуры: `df.info()`, `df.head()`, `df.describe()`
- Простые запросы:
  - Сколько записей по странам?
  - Какой временной период покрывают данные?
  - Какие товарные группы (TNVED2) наиболее представлены?

#### Часть 4: Подведение итогов (5 минут)
- Краткое резюме: что узнали
- Вопросы студентов
- Домашнее задание (опционально): изучить документацию `docs/data_model.md`

---

## ЗАНЯТИЕ 2: Старая и новая статистика: работа с данными до и после января 2022
**Длительность:** 80 минут

### Цели занятия:
- Понять разницу между старой статистикой ФТС и новой зеркальной статистикой
- Научиться работать с данными разных периодов
- Освоить базовые аналитические запросы

### Структура занятия:

#### Часть 1: Теоретический блок (20 минут)
**1.1. Исторический контекст (10 мин)**
- До января 2022: официальная статистика ФТС России
  - Прямые данные от российской таможни
  - Высокая детализация и точность
  - Доступность данных через официальные каналы
- После января 2022: переход на зеркальную статистику
  - Официальная статистика РФ стала недоступна
  - Использование данных стран-партнеров
  - Данные из UN Comtrade как дополнительный источник

**1.2. Различия в источниках данных (10 мин)**
- Национальные источники (Китай, Индия, Турция):
  - Структура данных на сайтах таможенных служб
  - Особенности сбора и обработки
  - Преимущества: оперативность, детализация
- UN Comtrade:
  - Что такое Comtrade и как он работает
  - Зеркальная статистика: как страна-партнер видит торговлю с РФ
  - Ограничения: задержка публикации, уровень агрегации

#### Часть 2: Практическая работа со старой статистикой (25 минут)
**2.1. Загрузка и изучение данных до 2022 года (10 мин)**
```python
# Фильтрация данных до января 2022
df_old = conn.execute("""
    SELECT * 
    FROM unified_trade_data 
    WHERE PERIOD < '2022-01-01'
    LIMIT 5000
""").df()

# Анализ структуры
print(f"Период: {df_old['PERIOD'].min()} - {df_old['PERIOD'].max()}")
print(f"Страны: {df_old['STRANA'].unique()}")
print(f"Источники: {df_old['SOURCE'].value_counts() if 'SOURCE' in df_old.columns else 'N/A'}")
```

**2.2. Анализ старой статистики (15 мин)**
- Топ-10 стран-партнеров по импорту в 2021 году:
  ```python
  top_import_2021 = conn.execute("""
      SELECT STRANA, SUM(STOIM) as total_import
      FROM unified_trade_data
      WHERE PERIOD >= '2021-01-01' AND PERIOD < '2022-01-01'
        AND NAPR = 'ИМ'
      GROUP BY STRANA
      ORDER BY total_import DESC
      LIMIT 10
  """).df()
  ```
- Динамика экспорта по месяцам 2021:
  ```python
  export_dynamics = conn.execute("""
      SELECT PERIOD, SUM(STOIM) as total_export
      FROM unified_trade_data
      WHERE PERIOD >= '2021-01-01' AND PERIOD < '2022-01-01'
        AND NAPR = 'ЭК'
      GROUP BY PERIOD
      ORDER BY PERIOD
  """).df()
  ```

#### Часть 3: Практическая работа с новой статистикой (30 минут)
**3.1. Загрузка данных после января 2022 (10 мин)**
```python
# Фильтрация данных после января 2022
df_new = conn.execute("""
    SELECT * 
    FROM unified_trade_data 
    WHERE PERIOD >= '2022-01-01'
    LIMIT 5000
""").df()

# Анализ источников данных
if 'SOURCE' in df_new.columns:
    print(df_new['SOURCE'].value_counts())
```

**3.2. Сравнительный анализ (20 мин)**
- Сравнение структуры торговли до и после 2022:
  ```python
  # Топ-5 стран-партнеров до и после
  before_2022 = conn.execute("""
      SELECT STRANA, SUM(STOIM) as total
      FROM unified_trade_data
      WHERE PERIOD >= '2021-01-01' AND PERIOD < '2022-01-01'
        AND NAPR = 'ИМ'
      GROUP BY STRANA
      ORDER BY total DESC
      LIMIT 5
  """).df()
  
  after_2022 = conn.execute("""
      SELECT STRANA, SUM(STOIM) as total
      FROM unified_trade_data
      WHERE PERIOD >= '2022-01-01'
        AND NAPR = 'ИМ'
      GROUP BY STRANA
      ORDER BY total DESC
      LIMIT 5
  """).df()
  ```
- Визуализация изменений (если время позволяет):
  ```python
  import matplotlib.pyplot as plt
  # Простой график динамики
  ```

#### Часть 4: Подведение итогов (5 минут)
- Ключевые выводы о различиях старой и новой статистики
- Вопросы студентов
- Домашнее задание: провести собственный сравнительный анализ по выбранной стране или товарной группе

---

## ЗАНЯТИЕ 3: DuckDB и практическая работа с данными
**Длительность:** 80 минут

### Цели занятия:
- Понять, что такое DuckDB и почему он используется в проекте
- Освоить SQL-запросы для работы с данными
- Научиться выполнять аналитические задачи

### Структура занятия:

#### Часть 1: Введение в DuckDB (15 минут)
**1.1. Что такое DuckDB? (10 мин)**
- Определение: аналитическая СУБД, оптимизированная для аналитических запросов
- Преимущества:
  - Работа с файлами (Parquet, CSV) без установки сервера
  - Высокая скорость выполнения аналитических запросов
  - SQL-интерфейс, знакомый многим
  - Эффективная работа с большими объемами данных
- Сравнение с другими решениями (PostgreSQL, SQLite)

**1.2. Структура базы данных проекта (5 мин)**
- Основная таблица: `unified_trade_data`
- Справочные таблицы: `country_reference`, `tnved_reference`
- Представления (views): `unified_trade_data_enriched`
- Демонстрация структуры через SQL:
  ```sql
  SHOW TABLES;
  DESCRIBE unified_trade_data;
  ```

#### Часть 2: Основы SQL для анализа данных (25 минут)
**2.1. Базовые запросы (10 мин)**
- SELECT, WHERE, GROUP BY, ORDER BY
- Агрегатные функции: SUM, COUNT, AVG, MIN, MAX
- Примеры:
  ```sql
  -- Общая стоимость импорта по странам за 2023 год
  SELECT STRANA, SUM(STOIM) as total_import
  FROM unified_trade_data
  WHERE PERIOD >= '2023-01-01' AND PERIOD < '2024-01-01'
    AND NAPR = 'ИМ'
  GROUP BY STRANA
  ORDER BY total_import DESC
  LIMIT 10;
  ```

**2.2. JOIN и работа со справочниками (15 мин)**
- Использование `unified_trade_data_enriched` для получения названий стран и товаров:
  ```sql
  SELECT 
      COUNTRY_NAME,
      TNVED2_NAME,
      SUM(STOIM) as total_value
  FROM unified_trade_data_enriched
  WHERE PERIOD >= '2023-01-01'
    AND NAPR = 'ИМ'
  GROUP BY COUNTRY_NAME, TNVED2_NAME
  ORDER BY total_value DESC
  LIMIT 20;
  ```
- Работа с физическими объемами:
  ```sql
  -- Импорт по весу (NETTO) и стоимости
  SELECT 
      STRANA,
      SUM(STOIM) as total_value_usd,
      SUM(NETTO) as total_weight_kg,
      SUM(STOIM) / NULLIF(SUM(NETTO), 0) as price_per_kg
  FROM unified_trade_data
  WHERE PERIOD >= '2023-01-01' AND PERIOD < '2024-01-01'
    AND NAPR = 'ИМ'
    AND NETTO > 0
  GROUP BY STRANA
  HAVING SUM(NETTO) > 1000000  -- более 1 млн кг
  ORDER BY total_value_usd DESC;
  ```

#### Часть 3: Практические аналитические задачи (35 минут)
**3.1. Задача 1: Анализ товарной структуры (15 мин)**
- Топ-10 товарных групп (TNVED2) по импорту за последний год:
  ```sql
  SELECT 
      t.TNVED2_NAME,
      SUM(t.STOIM) as total_import,
      COUNT(DISTINCT t.STRANA) as num_countries
  FROM unified_trade_data_enriched t
  WHERE t.PERIOD >= DATE_TRUNC('year', CURRENT_DATE) - INTERVAL '1 year'
    AND t.NAPR = 'ИМ'
  GROUP BY t.TNVED2_NAME
  ORDER BY total_import DESC
  LIMIT 10;
  ```

**3.2. Задача 2: Динамика торговли (10 мин)**
- Месячная динамика экспорта и импорта:
  ```sql
  SELECT 
      PERIOD,
      SUM(CASE WHEN NAPR = 'ИМ' THEN STOIM ELSE 0 END) as import_value,
      SUM(CASE WHEN NAPR = 'ЭК' THEN STOIM ELSE 0 END) as export_value
  FROM unified_trade_data
  WHERE PERIOD >= '2023-01-01'
  GROUP BY PERIOD
  ORDER BY PERIOD;
  ```

**3.3. Задача 3: Анализ физических объемов (10 мин)**
- Товары с наибольшим физическим объемом импорта:
  ```sql
  SELECT 
      t.TNVED4_NAME,
      SUM(t.NETTO) as total_weight_kg,
      SUM(t.STOIM) as total_value_usd,
      AVG(t.STOIM / NULLIF(t.NETTO, 0)) as avg_price_per_kg
  FROM unified_trade_data_enriched t
  WHERE t.PERIOD >= '2023-01-01'
    AND t.NAPR = 'ИМ'
    AND t.NETTO > 0
  GROUP BY t.TNVED4_NAME
  HAVING SUM(t.NETTO) > 10000000  -- более 10 млн кг
  ORDER BY total_weight_kg DESC
  LIMIT 10;
  ```

#### Часть 4: Экспорт данных и подведение итогов (5 минут)
- Экспорт результатов в CSV:
  ```python
  result_df = conn.execute("""
      -- ваш SQL запрос
  """).df()
  result_df.to_csv('export_analysis.csv', index=False)
  ```
- Вопросы студентов
- Домашнее задание: выполнить собственный аналитический запрос по интересующей теме

---

## ЗАНЯТИЕ 4: Superset дашборд и визуализация данных
**Длительность:** 80 минут

### Цели занятия:
- Понять, что такое Superset и как он работает
- Изучить структуру дашборда проекта
- Научиться создавать простые визуализации
- Понять, как дашборд подключается к DuckDB

### Структура занятия:

#### Часть 1: Введение в Apache Superset (20 минут)
**1.1. Что такое Superset? (10 мин)**
- Определение: open-source платформа для визуализации данных и бизнес-аналитики
- Основные возможности:
  - Подключение к различным базам данных (включая DuckDB)
  - Создание интерактивных дашбордов
  - Различные типы визуализаций (графики, таблицы, карты)
  - SQL Lab для выполнения запросов
- Преимущества использования Superset для аналитики

**1.2. Архитектура Superset в проекте (10 мин)**
- Демонстрация конфигурации (`superset/superset_config.py`)
- Подключение к DuckDB через SQLAlchemy
- Структура дашборда:
  - Источники данных (datasources)
  - Чарты (charts)
  - Дашборды (dashboards)
- Демонстрация работающего дашборда (если доступен)

#### Часть 2: Структура дашборда проекта (25 минут)
**2.1. Обзор дашборда (10 мин)**
- Демонстрация основных элементов дашборда:
  - Общая статистика (тоталы по импорту/экспорту)
  - Динамика по месяцам
  - Топ стран-партнеров
  - Товарная структура
  - Фильтры по периоду, стране, товарной группе

**2.2. Типы визуализаций в дашборде (15 мин)**
- Временные ряды (Time Series):
  - Динамика импорта/экспорта по месяцам
  - Сравнение периодов
- Столбчатые диаграммы (Bar Chart):
  - Топ стран-партнеров
  - Топ товарных групп
- Таблицы (Table):
  - Детализированные данные
  - Возможность экспорта
- Круговые диаграммы (Pie Chart):
  - Структура торговли по странам
  - Структура по товарным группам

#### Часть 3: Практическая работа с дашбордом (30 минут)
**3.1. Навигация по дашборду (10 мин)**
- Как использовать фильтры
- Как взаимодействовать с графиками (zoom, drill-down)
- Как экспортировать данные
- Практическое задание: найти данные по конкретной стране за определенный период

**3.2. SQL Lab в Superset (10 мин)**
- Демонстрация SQL Lab для выполнения запросов
- Примеры запросов:
  ```sql
  -- Простой запрос для проверки данных
  SELECT 
      PERIOD,
      STRANA,
      SUM(STOIM) as total
  FROM unified_trade_data
  WHERE PERIOD >= '2023-01-01'
  GROUP BY PERIOD, STRANA
  ORDER BY PERIOD DESC, total DESC
  LIMIT 100;
  ```
- Создание простой визуализации из результата запроса

**3.3. Создание простого чарта (10 мин)**
- Пошаговое создание простого графика:
  1. Выбор источника данных
  2. Выбор типа визуализации
  3. Настройка метрик и измерений
  4. Применение фильтров
  5. Сохранение чарта
- Пример: график динамики импорта из Китая за 2023 год

#### Часть 4: Интеграция DuckDB и Superset (5 минут)
**4.1. Как работает подключение (5 мин)**
- Конфигурация подключения к DuckDB в Superset
- Особенности работы с DuckDB:
  - Прямое чтение файлов Parquet
  - Высокая скорость выполнения запросов
  - Поддержка SQL стандарта
- Преимущества использования DuckDB для аналитики

#### Часть 5: Подведение итогов курса (10 минут)
**5.1. Резюме всех занятий (5 мин)**
- Что узнали:
  - Структура таможенной статистики
  - Различия старой и новой статистики
  - Работа с DuckDB и SQL
  - Визуализация данных в Superset

**5.2. Практическое применение (3 мин)**
- Как использовать полученные знания в профессиональной деятельности
- Возможности для дальнейшего изучения

**5.3. Вопросы и обратная связь (2 мин)**
- Ответы на вопросы студентов
- Сбор обратной связи о курсе

---

## Презентации и практика

- **Презентации (Quarto):** `lessons/lesson_01_intro.qmd` … `lesson_04_superset.qmd`
- **Рендер:** `quarto render lessons/*.qmd`
- **Практика (Python):** `lessons/practices/practice_01_intro.py` … `practice_04_superset.py`
- **Superset:** Доступ к инстансу предоставляется отдельно

---

## Материалы для подготовки к занятиям

### Необходимое ПО:
- Python 3.8+
- Библиотеки: pandas, duckdb
- Браузер для работы с Superset (если дашборд развернут)

### Документация проекта:
- `docs/data_model.md` - модель данных
- `docs/merge_processed_data-docs.md` - описание процесса обработки данных
- `project_architecture.md` - архитектура проекта

### Дополнительные ресурсы:
- Документация DuckDB: https://duckdb.org/docs/
- Документация Apache Superset: https://superset.apache.org/docs/
- UN Comtrade: https://comtradeplus.un.org/

---

## Рекомендации по проведению занятий

1. **Адаптация под уровень студентов:**
   - Если уровень Python низкий: больше времени на базовые операции с pandas
   - Если уровень высокий: можно добавить более сложные аналитические задачи

2. **Интерактивность:**
   - Поощрять вопросы во время занятия
   - Использовать практические примеры из реальных данных
   - Предлагать студентам выполнять запросы самостоятельно

3. **Практические задания:**
   - После каждого занятия можно давать небольшие задания
   - Финальное задание: создать собственный анализ по выбранной теме

4. **Технические моменты:**
   - Убедиться, что у всех студентов установлено необходимое ПО
   - Подготовить примеры данных для работы
   - Иметь резервный план на случай технических проблем
