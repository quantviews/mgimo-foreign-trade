---
title: "Занятие 1. Введение в таможенную статистику"
subtitle: "Курс: Международные технологические рынки и технологическое лидерство"
format:
  revealjs:
    theme: default
    fontsize: 18px
    slide-number: true
    chalkboard: false
    css: styles.css
---

## План занятия (80 мин)

1. **Теория** (25 мин): Таможенная статистика, ТН ВЭД, зеркальная статистика
2. **Структура проекта** (20 мин): Обзор проекта «Актуальная статистика внешней торговли»
3. **Практика** (30 мин): Первое знакомство с данными в Python
4. **Итоги** (5 мин)

---

## Что такое таможенная статистика?

**Определение:** Систематизированные данные о внешней торговле страны, формируемые на основе таможенных деклараций.

**Кто собирает:**

- **ФТС России** — до января 2022 публиковала детальную статистику
- **Национальные таможенные службы** — Китай, Индия, Турция и др.
- **UN Comtrade** — агрегированная международная база ООН

**Основные показатели:**

| Показатель | Описание | Единица |
|------------|----------|---------|
| **STOIM** | Статистическая стоимость | тыс. USD |
| **NETTO** | Вес нетто | кг |
| **KOL** | Количество в доп. единице | шт, л, м³ и т.д. |

---

## Направления торговли (`NAPR`)

::: columns
::: {.column width="50%"}

**ИМ (Импорт)** — товары, ввозимые в РФ

- С точки зрения РФ: что мы покупаем за рубежом
- Пример: китайский экспорт в РФ = российский импорт из Китая

:::
::: {.column width="50%"}

**ЭК (Экспорт)** — товары, вывозимые из РФ

- С точки зрения РФ: что мы продаём за рубеж
- Пример: российский экспорт в Турцию = турецкий импорт из РФ

:::
:::

**Важно:** При работе с зеркальной статистикой направление «отзеркаливается» — экспорт партнёра становится нашим импортом.

---

## Классификатор стран (`STRANA`)

**Справочник:** `metadata/STRANA.csv` — соответствие кодов стран и их названий.

| Колонка | Описание |
|---------|----------|
| **KOD** | Двухбуквенный код ISO 3166-1 alpha-2 (CN, RU, US...) |
| **NAME** | Официальное наименование страны на русском |

**Объём:** 254 записи (страны и территории). В данных ФТС используется код страны-партнёра по сделке.

---

## Примеры кодов стран (из STRANA.csv)

| Код | Страна |
|-----|--------|
| CN | КИТАЙ |
| RU | РОССИЯ |
| US | СОЕДИДИНЕННЫЕ ШТАТЫ |
| DE | ГЕРМАНИЯ |
| BY | БЕЛАРУСЬ |
| KZ | КАЗАХСТАН |
| TR | ТУРЦИЯ |
| IN | ИНДИЯ |
| KR | КОРЕЯ, РЕСПУБЛИКА |
| JP | ЯПОНИЯ |
| UA | УКРАИНА |
| GB | СОЕДИНЕННОЕ КОРОЛЕВСТВО |

*Специальные коды: EU — страны ЕС, NNN — неизвестная страна, AB/OS — Абхазия/Южная Осетия.*

**Использование:** В торговых данных колонка STRANA содержит только код. Для получения названия — JOIN со справочником:

```python
strana = pd.read_csv("metadata/STRANA.csv", sep="\t")
# Объединение с данными: df.merge(strana, left_on="STRANA", right_on="KOD")
```

---

## Что такое ТН ВЭД и зачем он нужен?

**Определение:** ТН ВЭД — классификатор товаров, используемый таможенными органами (ФТС России) для таможенных операций, применения пошлин и ведения статистики.

- **Фундамент:** В основе — Гармонизированная система (HS) Всемирной таможенной организации
- **Объём в проекте:** В `metadata/tnved.csv` — **31 532 записи** по 5 уровням вложенности
- **Принцип:** «От общего к частному» — с увеличением длины кода описание товара становится детальнее

---

## Иерархическая структура кода (10 знаков)

5 уровней классификации в `metadata/tnved.csv`:

| Знаков | Уровень | Пример | Роль |
|--------|---------|--------|------|
| **2** | Группа | `01` | Материал/отрасль (97 групп) |
| **4** | Товарная позиция | `0101` | Узкая категория (1 231 позиция) |
| **6** | Субпозиция | `010121` | Уровень HS, мировой стандарт (5 758) |
| **8** | Подсубпозиция | `01012100` | Уровень ЕАЭС (10 291) |
| **10** | Полный код | `0101210000` | Конкретный объект декларирования (14 155) |

---

## Распределение элементов по уровням (январь 2022)

| Уровень | Кол-во элементов | Роль в классификации |
|---------|------------------|----------------------|
| **2** (Группа) | 97 | Крупные разделы экономики |
| **4** (Позиция) | 1 231 | Видовые категории товаров |
| **6** (Субпозиция) | 5 758 | Мировой стандарт (HS) |
| **8** (Подсубпозиция) | 10 291 | Региональная специфика (ЕАЭС) |
| **10** (Товар) | 14 155 | Конкретный объект декларирования |

*Количество записей растёт к 10-му уровню — чем детальнее код, тем больше вариантов.*

---

## Пример 1: группа 01 (живые животные) — из tnved.csv

```
01      — ЖИВЫЕ ЖИВОТНЫЕ
0101    — ЛОШАДИ, ОСЛЫ, МУЛЫ И ЛОШАКИ ЖИВЫЕ
010121  — ЛОШАДИ ЖИВЫЕ: ЧИСТОПОРОДНЫЕ ПЛЕМЕННЫЕ ЖИВОТНЫЕ
01012100 — (то же на уровне 8 знаков)
0101210000 — (полная детализация, 10 знаков)
010129  — ЛОШАДИ ПРОЧИЕ
010130  — ОСЛЫ, ЖИВЫЕ
0102    — КРУПНЫЙ РОГАТЫЙ СКОТ ЖИВОЙ
0103    — СВИНЬИ ЖИВЫЕ
```

---

## Пример 2: группа 27 (топливо) — крупнейшая по обороту

```
27      — ТОПЛИВО МИНЕРАЛЬНОЕ, НЕФТЬ И ПРОДУКТЫ ИХ ПЕРЕГОНКИ; БИТУМИНОЗНЫЕ ВЕЩЕСТВА; ВОСКИ МИНЕРАЛЬНЫЕ
2701    — УГОЛЬ КАМЕННЫЙ; БРИКЕТЫ, ОКАТЫШИ...
2709    — НЕФТЬ СЫРАЯ И НЕФТЕПРОДУКТЫ СЫРЫЕ
2710    — НЕФТЬ И НЕФТЕПРОДУКТЫ (кроме сырых)
271012  — ЛЕГКИЕ ДИСТИЛЛЯТЫ (бензины)
27101241 — БЕНЗИНЫ МОТОРНЫЕ (с октановым числом < 95)
2710124110 — БЕНЗИН АВТОМОБИЛЬНЫЙ (октановое число < 80)
271019  — ПРОЧИЕ ДИСТИЛЛЯТЫ (дизель, керосин, мазут)
```

---

## Пример 3: группы 84, 85, 87 — машины и оборудование

```
84      — РЕАКТОРЫ ЯДЕРНЫЕ, КОТЛЫ, ОБОРУДОВАНИЕ И МЕХАНИЧЕСКИЕ УСТРОЙСТВА; ИХ ЧАСТИ
85      — ЭЛЕКТРИЧЕСКИЕ МАШИНЫ И ОБОРУДОВАНИЕ; ЗВУКОЗАПИСЫВАЮЩАЯ АППАРАТУРА...
87      — СРЕДСТВА НАЗЕМНОГО ТРАНСПОРТА (кроме ж/д)
```

Эти три группы — среди топ-5 по обороту в данных ФТС 2021–2022.

---

## Пример 4: Эволюция кода — смартфоны

Проследим путь классификации одного из самых популярных товаров:

```
85           — Электрические машины и оборудование... (Группа)
8517         — Аппараты телефонные, включая смартфоны... (Позиция)
851713       — Смартфоны (Субпозиция — введена в 2022 году)
85171300     — Смартфоны (Подсубпозиция)
8517130000   — Смартфоны (Полный 10-значный код ТН ВЭД)
```

*Префикс «ШТ-» в названии — указание на основную единицу измерения (штуки).*

---

## Технические особенности данных tnved.csv

Для аналитики важно понимать структуру файла:

| Колонка | Описание |
|---------|----------|
| **KOD** | Текстовое поле — сохранять ведущие нули (`01`, а не `1`) |
| **NAME** | Официальное наименование; может содержать единицы измерения (ШТ-, 1000 Л-), технические пояснения |
| **level** | Индикатор вложенности (2, 4, 6, 8, 10) — упрощает построение древовидных моделей в Excel, Python, Power BI |

---

## Особенности кодирования

- **Дополнение нулями справа:** `2710` → `2710000000` (до 10 знаков)
- **Иерархия:** каждый уровень — префикс следующего: `27` → `2701` → `271012` → `27101241` → `2710124110`

---

## Зеркальная статистика

**Определение:** Данные о торговле с РФ, собранные **страной-партнёром** (а не российской таможней).

**Почему важна:**
- С января 2022 официальная статистика ФТС недоступна
- Зеркальная статистика — единственный легальный источник актуальных данных
- Данные партнёров часто публикуются быстрее, чем UN Comtrade

**Источники в проекте:**
- Китай (customs.gov.cn)
- Индия (commerce.gov.in)
- Турция (trademap)
- UN Comtrade (для стран без национальных данных)

---

## Почему прямая и зеркальная статистика отличаются?

1. **CIF vs FOB:** Импорт учитывается по CIF (стоимость + страхование + фрахт), экспорт — по FOB (франко-борт)
2. **Страна происхождения vs страна отправления:** Транзитные операции
3. **Временной лаг:** Морские перевозки — товар в пути
4. **Разная классификация:** Один товар — разные коды ТН ВЭД в разных странах

---

## Структура проекта

```
mgimo-foreign_trade/
├── data_raw/fts_data/  # CSV ФТС по месяцам (янв 2021 — янв 2022)
├── data_processed/     # Сводные Parquet (fts_2021_2022.parquet и др.)
├── src/load_fts_csv.py # Объединение CSV ФТС в сводный датасет
├── src/collectors/     # Сборщики зеркальной статистики
├── db/                 # unified_trade_data.duckdb (после merge)
├── metadata/           # Справочники (страны, ТН ВЭД)
└── superset/           # Конфигурация дашборда
```

---

## Модель данных (схема)

| Колонка | Тип | Описание |
|---------|-----|----------|
| NAPR | VARCHAR | ИМ / ЭК |
| PERIOD | DATE | Отчётный период (YYYY-MM-DD) |
| STRANA | VARCHAR | ISO2 код страны (CN, TR, IN) |
| TNVED | VARCHAR | Код ТН ВЭД (8–10 знаков) |
| STOIM | DECIMAL | Стоимость, тыс. USD |
| NETTO | DECIMAL | Вес нетто, кг |
| KOL | DECIMAL | Количество в доп. единице |
| EDIZM | VARCHAR | Единица измерения |
| TNVED2, TNVED4, TNVED6 | VARCHAR | Агрегированные коды |

---

## Дополнительные единицы измерения (EDIZM)

**Справочник:** `metadata/edizm.csv` — стандартизированные единицы для колонки KOL.

| KOD | NAME |
|-----|------|
| 166 | КИЛОГРАММ |
| 168 | ТОННА (1000 КГ) |
| 796 | ШТУКА |
| 798 | ТЫСЯЧА ШТУК |
| 112 | ЛИТР |
| 130 | 1000 ЛИТРОВ |
| 113 | КУБИЧЕСКИЙ МЕТР |
| 006 | МЕТР |
| 055 | КВАДРАТНЫЙ МЕТР |
| 246 | 1000 КИЛОВАТТ-ЧАС |
| 323 | БЕККЕРЕЛЬ |

**Роль:** KOL — количество в единице EDIZM. NETTO — всегда вес в кг. Для товаров «в штуках» KOL даёт натуральный объём, для «в литрах» — объём и т.д.

---

## Натуральные показатели

Помимо стоимости (STOIM) таможенная статистика содержит **физические объёмы**:

| Показатель | Единица | Описание |
|------------|---------|----------|
| **NETTO** | кг | Вес нетто — есть почти у всех товаров |
| **KOL** | зависит от EDIZM | Количество в дополнительной единице (штуки, литры, м², кВт·ч...) |

**Зачем нужны:** Отделение ценовых эффектов от реальных объёмов. Рост стоимости может быть из-за роста цен или роста поставок — только натуральные показатели показывают реальные потоки.

---

## Эффективные цены по категориям

**Эффективная цена** — стоимость за единицу физического объёма:

- **Для весовых товаров (NETTO > 0):**  
  `цена за кг = STOIM / NETTO`  
  *(STOIM в тыс. USD → результат в тыс. USD/кг)*

- **Для штучных/объёмных (KOL > 0, EDIZM = ШТУКА и т.д.):**  
  `цена за единицу = STOIM / KOL`  
  *(при KOL в тыс. шт. — цена за тыс. шт.)*

**Важно:** Сравнивать цены только внутри одной товарной категории (одинаковый TNVED) и одной единицы измерения. Суммарные цены по группе: `SUM(STOIM) / SUM(NETTO)` или `SUM(STOIM) / SUM(KOL)`.

---

## Прямые данные ФТС

**Источник:** `data_raw/fts_data/` — CSV-файлы по месяцам (янв 2021 — янв 2022).

Это **прямая статистика** российской таможни до её закрытия. Идеальная точка старта для понимания структуры данных.


---

## Практика 2: Загрузка и просмотр данных ФТС

```python
import pandas as pd
from pathlib import Path

# Путь к сводному файлу (запускать из корня проекта)
parquet_path = Path("data_processed/fts_2021_2022.parquet")
df = pd.read_parquet(parquet_path)

print(f"Загружено строк: {len(df):,}")
print(f"Колонки: {df.columns.tolist()}")
print(df.head(10))
```

---

## Практика 3: Изучение структуры

```python
# Базовая информация
df.info()

# Описательная статистика
df[['STOIM', 'NETTO', 'KOL']].describe()

# Направления и страны
print("Направления:", df['NAPR'].unique())
print("Страны (топ-10):", df['STRANA'].value_counts().head(10))
print("Период:", df['PERIOD'].min(), "—", df['PERIOD'].max())
```

---

## Практика 4: Простые агрегации (pandas)

**Задание 1:** Сколько записей по каждой стране?

```python
by_country = df.groupby('STRANA').size().sort_values(ascending=False)
print(by_country.head(15))
```

**Задание 2:** Сумма импорта по странам за весь период

```python
import_by_country = df[df['NAPR'] == 'ИМ'].groupby('STRANA')['STOIM'].sum().sort_values(ascending=False)
print(import_by_country.head(10))
```

---

## Практика 5: Топ товарных групп (TNVED2)

```python
top_tnved2 = df.groupby('TNVED2').agg(
    total_stoim=('STOIM', 'sum'),
    cnt=('TNVED', 'count')
).sort_values('total_stoim', ascending=False).head(15)
print(top_tnved2)
```

---

## Практика 6: Единицы измерения и эффективные цены

**Задание 1:** Какие единицы измерения (EDIZM) чаще всего встречаются в данных?

```python
print(df['EDIZM'].value_counts().head(15))
```

**Задание 2:** Рассчитать среднюю эффективную цену (тыс. USD за тонну) по товарным группам TNVED2 для импорта. Использовать только строки, где NETTO > 0.

```python
imp = df[(df['NAPR'] == 'ИМ') & (df['NETTO'] > 0)]
price_by_tnved2 = imp.groupby('TNVED2').agg(
    total_stoim=('STOIM', 'sum'),
    total_netto=('NETTO', 'sum')
)
price_by_tnved2['price_per_tonne'] = price_by_tnved2['total_stoim'] / (price_by_tnved2['total_netto'] / 1000)
print(price_by_tnved2.sort_values('total_stoim', ascending=False).head(10))
```

**Задание 3:** Сравнить эффективные цены импорта из Китая и Германии по группе **2710** (нефтепродукты: бензин, дизель, мазут) за 2021 год. Группа более гомогенна, чем машины.

```python
g2710 = df[(df['NAPR'] == 'ИМ') & (df['TNVED4'] == '2710') & (df['NETTO'] > 0)
           & (df['PERIOD'].dt.year == 2021) & (df['STRANA'].isin(['CN', 'DE']))]
by_country = g2710.groupby('STRANA').agg(total_stoim=('STOIM', 'sum'), total_netto=('NETTO', 'sum'))
by_country['price_per_tonne'] = by_country['total_stoim'] / (by_country['total_netto'] / 1000)
print(by_country)
```

---

## Итоги занятия 1

- **Таможенная статистика** — данные о внешней торговле на основе таможенных деклараций
- **Классификаторы** — STRANA (страны), TNVED (товары), EDIZM (единицы измерения)
- **Натуральные показатели** — NETTO (кг), KOL (в единицах EDIZM)
- **Эффективная цена** — STOIM/NETTO или STOIM/KOL для анализа цен по категориям
- **Практика** — сводный датасет ФТС, агрегации, расчёт цен

**Домашнее задание:** Изучить `docs/data_model.md`, `docs/fts_csv_format.md`. Топ-5 стран по импорту за 2021 год. Выполнить Практику 6: рассчитать эффективные цены по группе 27 (топливо) для импорта из трёх стран-партнёров.

**Дополнительно:** Найти в `metadata/tnved.csv` самый длинный текст описания товара (колонка NAME). В группах 84 или 85 описания часто занимают несколько строк — это иллюстрирует сложность таможенного администрирования.

```python
# Поиск самого длинного описания
tnved = pd.read_csv("metadata/tnved.csv")
tnved["len_name"] = tnved["NAME"].str.len()
longest = tnved.loc[tnved["len_name"].idxmax()]
print(longest["KOD"], longest["NAME"][:200] + "...")
```
